====== 显示表的详情 ======
-L 不加参数则为filter表
-v 显示更多的信息保in，out列，以及包的多少以及总字节数
leo@HP:~$ sudo iptables -L 
Chain INPUT (policy ACCEPT)
target     prot opt source               destination         
DROP       tcp  --  39.156.68.154        anywhere             tcp spt:https
DROP       tcp  --  110.242.69.86        anywhere             tcp spt:https
DROP       tcp  --  124.237.176.248      anywhere             tcp spt:https
DROP       tcp  --  112.34.111.167       anywhere             tcp spt:http

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination         

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination         
leo@HP:~$ sudo iptables -L -nv --line-numbers
Chain INPUT (policy ACCEPT 1058 packets, 342K bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        0     0 DROP       tcp  --  *      *       39.156.68.154        0.0.0.0/0            tcp spt:443
2        0     0 DROP       tcp  --  *      *       110.242.69.86        0.0.0.0/0            tcp spt:443
3        0     0 DROP       tcp  --  *      *       124.237.176.248      0.0.0.0/0            tcp spt:443
4        7   420 DROP       tcp  --  *      *       112.34.111.167       0.0.0.0/0            tcp spt:80

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 351 packets, 36266 bytes)
num   pkts bytes target     prot opt in     out     source               destination         


=== -x 显示统计的精确值 ===

leo@HP:~$ sudo iptables -L -nv --line-numbers -x
Chain INPUT (policy ACCEPT 2749 packets, 1012233 bytes)
num      pkts      bytes target     prot opt in     out     source               destination         
1           0        0 DROP       tcp  --  *      *       39.156.68.154        0.0.0.0/0            tcp spt:443
2           0        0 DROP       tcp  --  *      *       110.242.69.86        0.0.0.0/0            tcp spt:443
3           0        0 DROP       tcp  --  *      *       124.237.176.248      0.0.0.0/0            tcp spt:443
4           7      420 DROP       tcp  --  *      *       112.34.111.167       0.0.0.0/0            tcp spt:80

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
num      pkts      bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 1641 packets, 135125 bytes)
num      pkts      bytes target     prot opt in     out     source               destination         

==== iptable -F ====

leo@HP:~$ sudo iptables -A INPUT -p tcp --sport 80 -j DROP
leo@HP:~$ sudo iptables -L INPUT -nvx
Chain INPUT (policy ACCEPT 23 packets, 3217 bytes)
    pkts      bytes target     prot opt in     out     source               destination         
       5      300 DROP       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp spt:80
leo@HP:~$ sudo iptables -F
leo@HP:~$ sudo iptables -L INPUT -nvx
Chain INPUT (policy ACCEPT 1 packets, 216 bytes)
    pkts      bytes target     prot opt in     out     source               destination         
leo@HP:~$ 
==== iptables -A INPUT -s 39.156.68.154 -j DROP ====
过滤所有源地址为39.156.68.154的包，在input挂在点filter表上

用ping命令icmp验证

leo@HP:~/Downloads$ sudo iptables -A INPUT -s 39.156.68.154 -j DROP
leo@HP:~/Downloads$ sudo iptables -L -nv
Chain INPUT (policy ACCEPT 9 packets, 1199 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 DROP       all  --  *      *       39.156.68.154        0.0.0.0/0           

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 6 packets, 618 bytes)
 pkts bytes target     prot opt in     out     source               destination         

成功插入规则，并查看规则，且规则并没有成功拦截的包

用ping命令进行发包

leo@HP:~/Downloads$ ping hao123.com
PING hao123.com (39.156.68.154) 56(84) bytes of data.
^C
--- hao123.com ping statistics ---
4 packets transmitted, 0 received, 100% packet loss, time 3050ms

leo@HP:~/Downloads$ 


发送4个，但是接受0个

eo@HP:~/Downloads$ sudo iptables -L INPUT -nv
Chain INPUT (policy ACCEPT 79 packets, 9219 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    4   336 DROP       all  --  *      *       39.156.68.154        0.0.0.0/0           
leo@HP:~/Downloads$ 

iptables统计与ping命令显示结果一致

leo@HP:~/Downloads$ sudo iptables -L INPUT -nv
Chain INPUT (policy ACCEPT 79 packets, 9219 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    4   336 DROP       all  --  *      *       39.156.68.154        0.0.0.0/0           
leo@HP:~/Downloads$ 

==== 命令顺序的先后，会影响处理包的优先级，排在前面的先处理包，accept和drop之后，会完成该包在该链上的执行 ====

accept在前的情况：
leo@HP:~/Downloads$ sudo iptables -L INPUT -vn --line-numbers
Chain INPUT (policy ACCEPT 14 packets, 1323 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        3   252 ACCEPT     all  --  *      *       39.156.68.154        0.0.0.0/0           
2        0     0 DROP       all  --  *      *       39.156.68.154        0.0.0.0/0           

leo@HP:~/Downloads$ ping hao123.com
PING hao123.com (39.156.68.154) 56(84) bytes of data.
64 bytes from 39.156.68.154 (39.156.68.154): icmp_seq=1 ttl=51 time=11.4 ms
64 bytes from 39.156.68.154 (39.156.68.154): icmp_seq=2 ttl=51 time=15.7 ms
64 bytes from 39.156.68.154 (39.156.68.154): icmp_seq=3 ttl=51 time=10.1 ms
^C
--- hao123.com ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2003ms
rtt min/avg/max/mdev = 10.155/12.427/15.701/2.375 ms
leo@HP:~/Downloads$ 

drop在前的情况：
leo@HP:~/Downloads$ sudo iptables -L INPUT -vn --line-numbers
Chain INPUT (policy ACCEPT 26 packets, 2899 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        3   252 DROP       all  --  *      *       39.156.68.154        0.0.0.0/0           
2        0     0 ACCEPT     all  --  *      *       39.156.68.154        0.0.0.0/0           
leo@HP:~/Downloads$ 

leo@HP:~/Downloads$ ping hao123.com
PING hao123.com (39.156.68.154) 56(84) bytes of data.
^C
--- hao123.com ping statistics ---
3 packets transmitted, 0 received, 100% packet loss, time 2041ms

leo@HP:~/Downloads$

==== 插入规则，-I chain number 数字是几，就将插入的规则设置为几插入，原来该位置上的规则向后移动 ====

leo@HP:~/Downloads$ sudo iptables -L INPUT -vn --line-numbers
Chain INPUT (policy ACCEPT 1 packets, 216 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        3   252 DROP       all  --  *      *       39.156.68.154        0.0.0.0/0           
2        0     0 ACCEPT     all  --  *      *       39.156.68.154        0.0.0.0/0           
leo@HP:~/Downloads$ sudo iptables -I INPUT 2 -p tcp --sport 433 -j ACCEPT
leo@HP:~/Downloads$ sudo iptables -L INPUT -vn --line-numbers
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        3   252 DROP       all  --  *      *       39.156.68.154        0.0.0.0/0           
2        0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp spt:433
3        0     0 ACCEPT     all  --  *      *       39.156.68.154        0.0.0.0/0           
leo@HP:~/Downloads$ 

==== iptables -D chain number or iptables -D chain rulus ====

按规则进行删除
leo@HP:~/Downloads$ sudo iptables -L INPUT -vn --line-numbers
[sudo] leo 的密码： 
Chain INPUT (policy ACCEPT 32774 packets, 34M bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        3   252 DROP       all  --  *      *       39.156.68.154        0.0.0.0/0           
2        0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp spt:433
3        0     0 ACCEPT     all  --  *      *       39.156.68.154        0.0.0.0/0           
leo@HP:~/Downloads$ sudo iptables -D INPUT -p tcp --sport 433 -j ACCEPT
leo@HP:~/Downloads$ sudo iptables -L INPUT -vn --line-numbers
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        3   252 DROP       all  --  *      *       39.156.68.154        0.0.0.0/0           
2        0     0 ACCEPT     all  --  *      *       39.156.68.154        0.0.0.0/0           


按规则编号删除
leo@HP:~/Downloads$ sudo iptables -D INPUT 2
leo@HP:~/Downloads$ sudo iptables -L INPUT -vn --line-numbers
Chain INPUT (policy ACCEPT 1 packets, 216 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        3   252 DROP       all  --  *      *       39.156.68.154        0.0.0.0/0           
leo@HP:~/Downloads$ 


==== iptables -t table -P chain target ====

leo@HP:~/Downloads$ sudo iptables -L -nv --line
Chain INPUT (policy ACCEPT 7097 packets, 3908K bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        3   252 DROP       all  --  *      *       39.156.68.154        0.0.0.0/0           

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 5360 packets, 716K bytes)
num   pkts bytes target     prot opt in     out     source               destination         

变换链的默认规则

leo@HP:~/Downloads$ sudo iptables -t filter -P INPUT DROP
leo@HP:~/Downloads$ sudo iptables -L -nv --line
Chain INPUT (policy DROP 12 packets, 1017 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        3   252 DROP       all  --  *      *       39.156.68.154        0.0.0.0/0           

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 8 packets, 494 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
leo@HP:~/Downloads$ sudo iptables -L -F
iptables v1.6.1: Cannot use -F with -L

Try `iptables -h' or 'iptables --help' for more information.
leo@HP:~/Downloads$ sudo iptables -F
leo@HP:~/Downloads$ sudo iptables -L -nv --line
Chain INPUT (policy DROP 16 packets, 1315 bytes)
num   pkts bytes target     prot opt in     out     source               destination         

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 8 packets, 460 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
leo@HP:~/Downloads$ sudo iptables -t filter -P INPUT ACCEPT
leo@HP:~/Downloads$ sudo iptables -L -nv --line
Chain INPUT (policy ACCEPT 6 packets, 716 bytes)
num   pkts bytes target     prot opt in     out     source               destination         

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 6 packets, 602 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
leo@HP:~/Downloads$ 

==== 设置好默认规则，如果不保存，重启之后，默认规则又变回最初的默认规则 ====

leo@HP:~/source/ikuai_gitsrc/iptables$ sudo iptables -t filter -P INPUT DROP
leo@HP:~/source/ikuai_gitsrc/iptables$ sudo iptables -L -vn
Chain INPUT (policy DROP 2 packets, 432 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
leo@HP:~/source/ikuai_gitsrc/iptables$

重启之后：

leo@HP:~$ sudo iptables -L -vn
[sudo] leo 的密码： 
Chain INPUT (policy ACCEPT 760 packets, 903K bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 565 packets, 45357 bytes)
 pkts bytes target     prot opt in     out     source               destination         
leo@HP:~$

==== iptables-save and iptables-restore ====

导出现有规则

leo@HP:~/source/ikuai_gitsrc/iptables$ sudo iptables-save > iptables-rules.txt 
leo@HP:~/source/ikuai_gitsrc/iptables$ cat iptables-rules.txt 
# Generated by iptables-save v1.6.1 on Wed May  5 17:16:55 2021
*filter
:INPUT ACCEPT [3202:2642941]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [2726:293664]
-A INPUT -s 112.34.111.167/32 -j DROP
COMMIT
# Completed on Wed May  5 17:16:55 2021

查看现有规则

leo@HP:~/source/ikuai_gitsrc/iptables$ sudo iptables -L -vn
Chain INPUT (policy ACCEPT 3206 packets, 2643K bytes)
 pkts bytes target     prot opt in     out     source               destination         
    7   420 DROP       all  --  *      *       112.34.111.167       0.0.0.0/0           

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 2726 packets, 294K bytes)
 pkts bytes target     prot opt in     out     source               destination         

清除现有规则

leo@HP:~/source/ikuai_gitsrc/iptables$ sudo iptables -F 

清除后查看规则

leo@HP:~/source/ikuai_gitsrc/iptables$ sudo iptables -L -vn
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

重新应用导出的规则进行恢复

leo@HP:~/source/ikuai_gitsrc/iptables$ sudo iptables-restore < iptables-rules.txt 

恢复后查看，规则已经恢复如初

leo@HP:~/source/ikuai_gitsrc/iptables$ sudo iptables -L -vn
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 DROP       all  --  *      *       112.34.111.167       0.0.0.0/0           

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
leo@HP:~/source/ikuai_gitsrc/iptables$ 

==== 重启之后，iptables-restore的结果不保存，查看iptables规则如下 ====

leo@HP:~$ sudo iptables -L -vn
[sudo] leo 的密码： 
Chain INPUT (policy ACCEPT 93 packets, 8333 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 71 packets, 5342 bytes)
 pkts bytes target     prot opt in     out     source               destination         
leo@HP:~$ 

==== REJECT and DROP ====

REJECT行为，设置后对方均给出了拒绝的回复

root@OpenWrt:/# iptables -L INPUT -t filter -vn --line
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        0     0 REJECT     icmp --  *      *       192.168.2.102        0.0.0.0/0            reject-with icmp-port-unreachable
2        1    60 REJECT     tcp  --  *      *       192.168.2.102        0.0.0.0/0            reject-with icmp-port-unreachable
root@OpenWrt:/# 

leo@HP:~/source/ikuai_gitsrc/iptables$ netcat -vz 192.168.2.103 22
netcat: connect to 192.168.2.103 port 22 (tcp) failed: Connection refused
leo@HP:~/source/ikuai_gitsrc/iptables$ ping 192.168.2.103
PING 192.168.2.103 (192.168.2.103) 56(84) bytes of data.
From 192.168.2.103 icmp_seq=1 Destination Port Unreachable
From 192.168.2.103 icmp_seq=2 Destination Port Unreachable
^C
--- 192.168.2.103 ping statistics ---
2 packets transmitted, 0 received, +2 errors, 100% packet loss, time 1008ms

leo@HP:~/source/ikuai_gitsrc/iptables$


DROP后的行为均是没有相应超时

root@OpenWrt:/# iptables -L INPUT -t filter -vn --line
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        2   168 DROP       icmp --  *      *       192.168.2.102        0.0.0.0/0           
2        0     0 DROP       tcp  --  *      *       192.168.2.102        0.0.0.0/0           

leo@HP:~/source/ikuai_gitsrc/iptables$ ping 192.168.2.103
PING 192.168.2.103 (192.168.2.103) 56(84) bytes of data.
^C
--- 192.168.2.103 ping statistics ---
2 packets transmitted, 0 received, 100% packet loss, time 1014ms

leo@HP:~/source/ikuai_gitsrc/iptables$ netcat -vz 192.168.2.103 22
netcat: connect to 192.168.2.103 port 22 (tcp) failed: Connection timed out
leo@HP:~/source/ikuai_gitsrc/iptables$

==== iptables -A INPUT -t filter -s ip1,ip2 -j REJECT ====

leo@HP:~/source/ikuai_gitsrc/iptables$ sudo iptables -t filter -A INPUT -s 112.34.111.167,39.156.68.154 -j REJECT
leo@HP:~/source/ikuai_gitsrc/iptables$ sudo iptables -L -vn
[sudo] leo 的密码： 
Chain INPUT (policy ACCEPT 75118 packets, 29M bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 REJECT     all  --  *      *       112.34.111.167       0.0.0.0/0            reject-with icmp-port-unreachable
    3   252 REJECT     all  --  *      *       39.156.68.154        0.0.0.0/0            reject-with icmp-port-unreachable

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 71903 packets, 9195K bytes)
 pkts bytes target     prot opt in     out     source               destination         
leo@HP:~/source/ikuai_gitsrc/iptables$ 

==== ! -s ip rule ====

leo@HP:~/source/ikuai_gitsrc/iptables$ sudo iptables -L -vn --line
Chain INPUT (policy ACCEPT 2 packets, 168 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1       25  3995 DROP       all  --  *      *      !39.156.68.154        0.0.0.0/0           

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 12 packets, 904 bytes)
num   pkts bytes target     prot opt in     out     source               destination         

不是该ip的包全都丢掉
leo@HP:~/source/ikuai_gitsrc/iptables$ ping 39.156.68.154
PING 39.156.68.154 (39.156.68.154) 56(84) bytes of data.
64 bytes from 39.156.68.154: icmp_seq=1 ttl=51 time=10.7 ms
64 bytes from 39.156.68.154: icmp_seq=2 ttl=51 time=9.90 ms
^C
--- 39.156.68.154 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1001ms
rtt min/avg/max/mdev = 9.904/10.324/10.744/0.420 ms
leo@HP:~/source/ikuai_gitsrc/iptables$ ping 192.168.2.103
PING 192.168.2.103 (192.168.2.103) 56(84) bytes of data.
^C
--- 192.168.2.103 ping statistics ---
2 packets transmitted, 0 received, 100% packet loss, time 1023ms

leo@HP:~/source/ikuai_gitsrc/iptables$ vim notes.log 

