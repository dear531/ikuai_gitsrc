====== 显示表的详情 ======
-L 不加参数则为filter表
-v 显示更多的信息保in，out列，以及包的多少以及总字节数
leo@HP:~$ sudo iptables -L 
Chain INPUT (policy ACCEPT)
target     prot opt source               destination         
DROP       tcp  --  39.156.68.154        anywhere             tcp spt:https
DROP       tcp  --  110.242.69.86        anywhere             tcp spt:https
DROP       tcp  --  124.237.176.248      anywhere             tcp spt:https
DROP       tcp  --  112.34.111.167       anywhere             tcp spt:http

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination         

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination         
leo@HP:~$ sudo iptables -L -nv --line-numbers
Chain INPUT (policy ACCEPT 1058 packets, 342K bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        0     0 DROP       tcp  --  *      *       39.156.68.154        0.0.0.0/0            tcp spt:443
2        0     0 DROP       tcp  --  *      *       110.242.69.86        0.0.0.0/0            tcp spt:443
3        0     0 DROP       tcp  --  *      *       124.237.176.248      0.0.0.0/0            tcp spt:443
4        7   420 DROP       tcp  --  *      *       112.34.111.167       0.0.0.0/0            tcp spt:80

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 351 packets, 36266 bytes)
num   pkts bytes target     prot opt in     out     source               destination         


=== -x 显示统计的精确值 ===

leo@HP:~$ sudo iptables -L -nv --line-numbers -x
Chain INPUT (policy ACCEPT 2749 packets, 1012233 bytes)
num      pkts      bytes target     prot opt in     out     source               destination         
1           0        0 DROP       tcp  --  *      *       39.156.68.154        0.0.0.0/0            tcp spt:443
2           0        0 DROP       tcp  --  *      *       110.242.69.86        0.0.0.0/0            tcp spt:443
3           0        0 DROP       tcp  --  *      *       124.237.176.248      0.0.0.0/0            tcp spt:443
4           7      420 DROP       tcp  --  *      *       112.34.111.167       0.0.0.0/0            tcp spt:80

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
num      pkts      bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 1641 packets, 135125 bytes)
num      pkts      bytes target     prot opt in     out     source               destination         

==== iptable -F ====

leo@HP:~$ sudo iptables -A INPUT -p tcp --sport 80 -j DROP
leo@HP:~$ sudo iptables -L INPUT -nvx
Chain INPUT (policy ACCEPT 23 packets, 3217 bytes)
    pkts      bytes target     prot opt in     out     source               destination         
       5      300 DROP       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp spt:80
leo@HP:~$ sudo iptables -F
leo@HP:~$ sudo iptables -L INPUT -nvx
Chain INPUT (policy ACCEPT 1 packets, 216 bytes)
    pkts      bytes target     prot opt in     out     source               destination         
leo@HP:~$ 
==== iptables -A INPUT -s 39.156.68.154 -j DROP ====
过滤所有源地址为39.156.68.154的包，在input挂在点filter表上

用ping命令icmp验证

leo@HP:~/Downloads$ sudo iptables -A INPUT -s 39.156.68.154 -j DROP
leo@HP:~/Downloads$ sudo iptables -L -nv
Chain INPUT (policy ACCEPT 9 packets, 1199 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 DROP       all  --  *      *       39.156.68.154        0.0.0.0/0           

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 6 packets, 618 bytes)
 pkts bytes target     prot opt in     out     source               destination         

成功插入规则，并查看规则，且规则并没有成功拦截的包

用ping命令进行发包

leo@HP:~/Downloads$ ping hao123.com
PING hao123.com (39.156.68.154) 56(84) bytes of data.
^C
--- hao123.com ping statistics ---
4 packets transmitted, 0 received, 100% packet loss, time 3050ms

leo@HP:~/Downloads$ 


发送4个，但是接受0个

eo@HP:~/Downloads$ sudo iptables -L INPUT -nv
Chain INPUT (policy ACCEPT 79 packets, 9219 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    4   336 DROP       all  --  *      *       39.156.68.154        0.0.0.0/0           
leo@HP:~/Downloads$ 

iptables统计与ping命令显示结果一致

leo@HP:~/Downloads$ sudo iptables -L INPUT -nv
Chain INPUT (policy ACCEPT 79 packets, 9219 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    4   336 DROP       all  --  *      *       39.156.68.154        0.0.0.0/0           
leo@HP:~/Downloads$ 

==== 命令顺序的先后，会影响处理包的优先级，排在前面的先处理包，accept和drop之后，会完成该包在该链上的执行 ====

accept在前的情况：
leo@HP:~/Downloads$ sudo iptables -L INPUT -vn --line-numbers
Chain INPUT (policy ACCEPT 14 packets, 1323 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        3   252 ACCEPT     all  --  *      *       39.156.68.154        0.0.0.0/0           
2        0     0 DROP       all  --  *      *       39.156.68.154        0.0.0.0/0           

leo@HP:~/Downloads$ ping hao123.com
PING hao123.com (39.156.68.154) 56(84) bytes of data.
64 bytes from 39.156.68.154 (39.156.68.154): icmp_seq=1 ttl=51 time=11.4 ms
64 bytes from 39.156.68.154 (39.156.68.154): icmp_seq=2 ttl=51 time=15.7 ms
64 bytes from 39.156.68.154 (39.156.68.154): icmp_seq=3 ttl=51 time=10.1 ms
^C
--- hao123.com ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2003ms
rtt min/avg/max/mdev = 10.155/12.427/15.701/2.375 ms
leo@HP:~/Downloads$ 

drop在前的情况：
leo@HP:~/Downloads$ sudo iptables -L INPUT -vn --line-numbers
Chain INPUT (policy ACCEPT 26 packets, 2899 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        3   252 DROP       all  --  *      *       39.156.68.154        0.0.0.0/0           
2        0     0 ACCEPT     all  --  *      *       39.156.68.154        0.0.0.0/0           
leo@HP:~/Downloads$ 

leo@HP:~/Downloads$ ping hao123.com
PING hao123.com (39.156.68.154) 56(84) bytes of data.
^C
--- hao123.com ping statistics ---
3 packets transmitted, 0 received, 100% packet loss, time 2041ms

leo@HP:~/Downloads$

==== 插入规则，-I chain number 数字是几，就将插入的规则设置为几插入，原来该位置上的规则向后移动 ====

leo@HP:~/Downloads$ sudo iptables -L INPUT -vn --line-numbers
Chain INPUT (policy ACCEPT 1 packets, 216 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        3   252 DROP       all  --  *      *       39.156.68.154        0.0.0.0/0           
2        0     0 ACCEPT     all  --  *      *       39.156.68.154        0.0.0.0/0           
leo@HP:~/Downloads$ sudo iptables -I INPUT 2 -p tcp --sport 433 -j ACCEPT
leo@HP:~/Downloads$ sudo iptables -L INPUT -vn --line-numbers
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        3   252 DROP       all  --  *      *       39.156.68.154        0.0.0.0/0           
2        0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp spt:433
3        0     0 ACCEPT     all  --  *      *       39.156.68.154        0.0.0.0/0           
leo@HP:~/Downloads$ 

==== iptables -D chain number or iptables -D chain rulus ====

按规则进行删除
leo@HP:~/Downloads$ sudo iptables -L INPUT -vn --line-numbers
[sudo] leo 的密码： 
Chain INPUT (policy ACCEPT 32774 packets, 34M bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        3   252 DROP       all  --  *      *       39.156.68.154        0.0.0.0/0           
2        0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp spt:433
3        0     0 ACCEPT     all  --  *      *       39.156.68.154        0.0.0.0/0           
leo@HP:~/Downloads$ sudo iptables -D INPUT -p tcp --sport 433 -j ACCEPT
leo@HP:~/Downloads$ sudo iptables -L INPUT -vn --line-numbers
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        3   252 DROP       all  --  *      *       39.156.68.154        0.0.0.0/0           
2        0     0 ACCEPT     all  --  *      *       39.156.68.154        0.0.0.0/0           


按规则编号删除
leo@HP:~/Downloads$ sudo iptables -D INPUT 2
leo@HP:~/Downloads$ sudo iptables -L INPUT -vn --line-numbers
Chain INPUT (policy ACCEPT 1 packets, 216 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        3   252 DROP       all  --  *      *       39.156.68.154        0.0.0.0/0           
leo@HP:~/Downloads$ 


==== iptables -t table -P chain target ====

leo@HP:~/Downloads$ sudo iptables -L -nv --line
Chain INPUT (policy ACCEPT 7097 packets, 3908K bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        3   252 DROP       all  --  *      *       39.156.68.154        0.0.0.0/0           

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 5360 packets, 716K bytes)
num   pkts bytes target     prot opt in     out     source               destination         

变换链的默认规则

leo@HP:~/Downloads$ sudo iptables -t filter -P INPUT DROP
leo@HP:~/Downloads$ sudo iptables -L -nv --line
Chain INPUT (policy DROP 12 packets, 1017 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        3   252 DROP       all  --  *      *       39.156.68.154        0.0.0.0/0           

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 8 packets, 494 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
leo@HP:~/Downloads$ sudo iptables -L -F
iptables v1.6.1: Cannot use -F with -L

Try `iptables -h' or 'iptables --help' for more information.
leo@HP:~/Downloads$ sudo iptables -F
leo@HP:~/Downloads$ sudo iptables -L -nv --line
Chain INPUT (policy DROP 16 packets, 1315 bytes)
num   pkts bytes target     prot opt in     out     source               destination         

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 8 packets, 460 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
leo@HP:~/Downloads$ sudo iptables -t filter -P INPUT ACCEPT
leo@HP:~/Downloads$ sudo iptables -L -nv --line
Chain INPUT (policy ACCEPT 6 packets, 716 bytes)
num   pkts bytes target     prot opt in     out     source               destination         

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 6 packets, 602 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
leo@HP:~/Downloads$ 

==== 设置好默认规则，如果不保存，重启之后，默认规则又变回最初的默认规则 ====

leo@HP:~/source/ikuai_gitsrc/iptables$ sudo iptables -t filter -P INPUT DROP
leo@HP:~/source/ikuai_gitsrc/iptables$ sudo iptables -L -vn
Chain INPUT (policy DROP 2 packets, 432 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
leo@HP:~/source/ikuai_gitsrc/iptables$

重启之后：

leo@HP:~$ sudo iptables -L -vn
[sudo] leo 的密码： 
Chain INPUT (policy ACCEPT 760 packets, 903K bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 565 packets, 45357 bytes)
 pkts bytes target     prot opt in     out     source               destination         
leo@HP:~$

==== iptables-save and iptables-restore ====

导出现有规则

leo@HP:~/source/ikuai_gitsrc/iptables$ sudo iptables-save > iptables-rules.txt 
leo@HP:~/source/ikuai_gitsrc/iptables$ cat iptables-rules.txt 
# Generated by iptables-save v1.6.1 on Wed May  5 17:16:55 2021
*filter
:INPUT ACCEPT [3202:2642941]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [2726:293664]
-A INPUT -s 112.34.111.167/32 -j DROP
COMMIT
# Completed on Wed May  5 17:16:55 2021

查看现有规则

leo@HP:~/source/ikuai_gitsrc/iptables$ sudo iptables -L -vn
Chain INPUT (policy ACCEPT 3206 packets, 2643K bytes)
 pkts bytes target     prot opt in     out     source               destination         
    7   420 DROP       all  --  *      *       112.34.111.167       0.0.0.0/0           

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 2726 packets, 294K bytes)
 pkts bytes target     prot opt in     out     source               destination         

清除现有规则

leo@HP:~/source/ikuai_gitsrc/iptables$ sudo iptables -F 

清除后查看规则

leo@HP:~/source/ikuai_gitsrc/iptables$ sudo iptables -L -vn
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

重新应用导出的规则进行恢复

leo@HP:~/source/ikuai_gitsrc/iptables$ sudo iptables-restore < iptables-rules.txt 

恢复后查看，规则已经恢复如初

leo@HP:~/source/ikuai_gitsrc/iptables$ sudo iptables -L -vn
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 DROP       all  --  *      *       112.34.111.167       0.0.0.0/0           

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
leo@HP:~/source/ikuai_gitsrc/iptables$ 

==== 重启之后，iptables-restore的结果不保存，查看iptables规则如下 ====

leo@HP:~$ sudo iptables -L -vn
[sudo] leo 的密码： 
Chain INPUT (policy ACCEPT 93 packets, 8333 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 71 packets, 5342 bytes)
 pkts bytes target     prot opt in     out     source               destination         
leo@HP:~$ 

==== REJECT and DROP ====

REJECT行为，设置后对方均给出了拒绝的回复

root@OpenWrt:/# iptables -L INPUT -t filter -vn --line
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        0     0 REJECT     icmp --  *      *       192.168.2.102        0.0.0.0/0            reject-with icmp-port-unreachable
2        1    60 REJECT     tcp  --  *      *       192.168.2.102        0.0.0.0/0            reject-with icmp-port-unreachable
root@OpenWrt:/# 

leo@HP:~/source/ikuai_gitsrc/iptables$ netcat -vz 192.168.2.103 22
netcat: connect to 192.168.2.103 port 22 (tcp) failed: Connection refused
leo@HP:~/source/ikuai_gitsrc/iptables$ ping 192.168.2.103
PING 192.168.2.103 (192.168.2.103) 56(84) bytes of data.
From 192.168.2.103 icmp_seq=1 Destination Port Unreachable
From 192.168.2.103 icmp_seq=2 Destination Port Unreachable
^C
--- 192.168.2.103 ping statistics ---
2 packets transmitted, 0 received, +2 errors, 100% packet loss, time 1008ms

leo@HP:~/source/ikuai_gitsrc/iptables$


DROP后的行为均是没有相应超时

root@OpenWrt:/# iptables -L INPUT -t filter -vn --line
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        2   168 DROP       icmp --  *      *       192.168.2.102        0.0.0.0/0           
2        0     0 DROP       tcp  --  *      *       192.168.2.102        0.0.0.0/0           

leo@HP:~/source/ikuai_gitsrc/iptables$ ping 192.168.2.103
PING 192.168.2.103 (192.168.2.103) 56(84) bytes of data.
^C
--- 192.168.2.103 ping statistics ---
2 packets transmitted, 0 received, 100% packet loss, time 1014ms

leo@HP:~/source/ikuai_gitsrc/iptables$ netcat -vz 192.168.2.103 22
netcat: connect to 192.168.2.103 port 22 (tcp) failed: Connection timed out
leo@HP:~/source/ikuai_gitsrc/iptables$

==== iptables -A INPUT -t filter -s ip1,ip2 -j REJECT ====

leo@HP:~/source/ikuai_gitsrc/iptables$ sudo iptables -t filter -A INPUT -s 112.34.111.167,39.156.68.154 -j REJECT
leo@HP:~/source/ikuai_gitsrc/iptables$ sudo iptables -L -vn
[sudo] leo 的密码： 
Chain INPUT (policy ACCEPT 75118 packets, 29M bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 REJECT     all  --  *      *       112.34.111.167       0.0.0.0/0            reject-with icmp-port-unreachable
    3   252 REJECT     all  --  *      *       39.156.68.154        0.0.0.0/0            reject-with icmp-port-unreachable

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 71903 packets, 9195K bytes)
 pkts bytes target     prot opt in     out     source               destination         
leo@HP:~/source/ikuai_gitsrc/iptables$ 

==== ! -s ip rule ====

leo@HP:~/source/ikuai_gitsrc/iptables$ sudo iptables -L -vn --line
Chain INPUT (policy ACCEPT 2 packets, 168 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1       25  3995 DROP       all  --  *      *      !39.156.68.154        0.0.0.0/0           

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 12 packets, 904 bytes)
num   pkts bytes target     prot opt in     out     source               destination         

不是该ip的包全都丢掉
leo@HP:~/source/ikuai_gitsrc/iptables$ ping 39.156.68.154
PING 39.156.68.154 (39.156.68.154) 56(84) bytes of data.
64 bytes from 39.156.68.154: icmp_seq=1 ttl=51 time=10.7 ms
64 bytes from 39.156.68.154: icmp_seq=2 ttl=51 time=9.90 ms
^C
--- 39.156.68.154 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1001ms
rtt min/avg/max/mdev = 9.904/10.324/10.744/0.420 ms
leo@HP:~/source/ikuai_gitsrc/iptables$ ping 192.168.2.103
PING 192.168.2.103 (192.168.2.103) 56(84) bytes of data.
^C
--- 192.168.2.103 ping statistics ---
2 packets transmitted, 0 received, 100% packet loss, time 1023ms

leo@HP:~/source/ikuai_gitsrc/iptables$ vim notes.log 

==== -A ip/mask ====

leo@leo-virtual-machine:/etc/phpldapadmin$ ping 192.168.3.201
PING 192.168.3.201 (192.168.3.201) 56(84) bytes of data.
^C
--- 192.168.3.201 ping statistics ---
2 packets transmitted, 0 received, 100% packet loss, time 1019ms

leo@leo-virtual-machine:/etc/phpldapadmin$ sudo iptables -L  -t filter -vn
Chain INPUT (policy ACCEPT 19 packets, 1383 bytes)
 pkts bytes target     prot opt in     out     source               destination         
   38  5269 DROP       all  --  *      *       192.168.3.0/24       0.0.0.0/0           

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 20 packets, 1540 bytes)
 pkts bytes target     prot opt in     out     source               destination         
leo@leo-virtual-machine:/etc/phpldapadmin$ 

===== -A ip/mask for REJECT ====

leo@leo-virtual-machine:/etc/phpldapadmin$ sudo iptables -L  -t filter -vn
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    1    78 REJECT     all  --  *      *       192.168.3.0/24       0.0.0.0/0            reject-with icmp-port-unreachable

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
leo@leo-virtual-machine:/etc/phpldapadmin$ ping 192.168.3.201
PING 192.168.3.201 (192.168.3.201) 56(84) bytes of data.
^C
--- 192.168.3.201 ping statistics ---
2 packets transmitted, 0 received, 100% packet loss, time 1027ms

leo@leo-virtual-machine:/etc/phpldapadmin$ ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: ens33: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UNKNOWN group default qlen 1000
    link/ether 00:0c:29:44:72:44 brd ff:ff:ff:ff:ff:ff
    inet 192.168.3.139/24 brd 192.168.3.255 scope global dynamic noprefixroute ens33
       valid_lft 4624sec preferred_lft 4624sec
    inet6 fe80::65c:4fc1:76bc:d8b6/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever
leo@leo-virtual-machine:/etc/phpldapadmin$ sudo iptables -L INPUT -t filter -vn
Chain INPUT (policy ACCEPT 2 packets, 684 bytes)
 pkts bytes target     prot opt in     out     source               destination         
   44  7174 REJECT     all  --  *      *       192.168.3.0/24       0.0.0.0/0            reject-with icmp-port-unreachable
leo@leo-virtual-machine:/etc/phpldapadmin$

==== append rule and default rule target ====

添加规则为不为192.168.3.0/24段则接受 
leo@leo-virtual-machine:/etc/phpldapadmin$ sudo iptables -L INPUT -t filter -vn
Chain INPUT (policy ACCEPT 12 packets, 1371 bytes)
 pkts bytes target     prot opt in     out     source               destination         
   12  1006 ACCEPT     all  --  *      *      !192.168.3.0/24       0.0.0.0/0           

当ping是该网段的包时，事实上未匹配上任何规则，则走默认规则，还是接受
但有一个明显的区别，就在于该包是通过未匹配上规则的方式通过的
leocheung@leocheung-CW65S:~/source/ikuai_gitsrc/iptables$ ping 192.168.3.139
PING 192.168.3.139 (192.168.3.139) 56(84) bytes of data.
64 bytes from 192.168.3.139: icmp_seq=1 ttl=64 time=0.531 ms
64 bytes from 192.168.3.139: icmp_seq=2 ttl=64 time=0.264 ms
64 bytes from 192.168.3.139: icmp_seq=3 ttl=64 time=0.599 ms
^C
--- 192.168.3.139 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2002ms
rtt min/avg/max/mdev = 0.264/0.464/0.599/0.146 ms
leocheung@leocheung-CW65S:~/source/ikuai_gitsrc/iptables$ 
==== 完全匹配和部分匹配 ====

leo@HP:~/source/openwrt/bin/targets/x86/generic$ sudo iptables -L INPUT -t filter -vn
Chain INPUT (policy ACCEPT 66 packets, 12438 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    2   168 DROP       icmp --  *      *       192.168.2.104        192.168.2.102       
leo@HP:~/source/openwrt/bin/targets/x86/generic$

源地址不匹配目的地址匹配，是匹配不上的

root@OpenWrt:/# ip addr show br-lan
3: br-lan: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP qlen 1000
    link/ether 52:54:00:bc:0a:0b brd ff:ff:ff:ff:ff:ff
    inet 192.168.2.103/24 brd 192.168.2.255 scope global br-lan
       valid_lft forever preferred_lft forever
    inet6 fe80::5054:ff:febc:a0b/64 scope link 
       valid_lft forever preferred_lft forever
root@OpenWrt:/# ping 192.168.2.102
PING 192.168.2.102 (192.168.2.102): 56 data bytes
64 bytes from 192.168.2.102: seq=0 ttl=64 time=0.310 ms
64 bytes from 192.168.2.102: seq=1 ttl=64 time=0.471 ms
^C
--- 192.168.2.102 ping statistics ---
2 packets transmitted, 2 packets received, 0% packet loss
round-trip min/avg/max = 0.310/0.390/0.471 ms
root@OpenWrt:/# 

完全匹配被丢弃

root@OpenWrt:/# ip addr show br-lan
3: br-lan: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP qlen 1000
    link/ether 52:54:00:20:04:67 brd ff:ff:ff:ff:ff:ff
    inet 192.168.2.104/24 brd 192.168.2.255 scope global br-lan
       valid_lft forever preferred_lft forever
    inet6 fdc7:3236:7eea::1/60 scope global noprefixroute 
       valid_lft forever preferred_lft forever
    inet6 fe80::5054:ff:fe20:467/64 scope link 
       valid_lft forever preferred_lft forever
root@OpenWrt:/# ping 192.168.2.102
PING 192.168.2.102 (192.168.2.102): 56 data bytes
^C
--- 192.168.2.102 ping statistics ---
2 packets transmitted, 0 packets received, 100% packet loss
root@OpenWrt:/# 


==== iptables -p number ====

leo@HP:~/source/ikuai_gitsrc/iptables$ cat /etc/protocols  |grep -i tcp
tcp	6	TCP		# transmission control protocol
leo@HP:~/source/ikuai_gitsrc/iptables$ sudo iptables -t filter -A INPUT -p 6 -j REJECT
leo@HP:~/source/ikuai_gitsrc/iptables$ sudo iptables -t filter -L INPUT
Chain INPUT (policy ACCEPT)
target     prot opt source               destination         
REJECT     tcp  --  anywhere             anywhere             reject-with icmp-port-unreachable
leo@HP:~/source/ikuai_gitsrc/iptables$ netcat -vz 127.0.0.1 22
netcat: connect to 127.0.0.1 port 22 (tcp) failed: Connection refused

==== iptable -i interface[+] ====

拒绝所有所有br开头上的icmp报文

leocheung@leocheung-CW65S:~$ sudo iptables -t filter -R INPUT 5 -i br+ -p icmp -j REJECT
leocheung@leocheung-CW65S:~$ sudo iptables -t filter -L INPUT -nv --line
Chain INPUT (policy ACCEPT 32 packets, 4120 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        0     0 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:53
2        0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:53
3        0     0 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:67
4        0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:67
5        0     0 REJECT     icmp --  br+    *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable
leocheung@leocheung-CW65S:~$

对端发起ping命令

root@iKuai:/root$ping 169.254.8.40
PING 169.254.8.40 (169.254.8.40) 56(84) bytes of data.
From 169.254.8.40 icmp_seq=1 Destination Port Unreachable
From 169.254.8.40 icmp_seq=2 Destination Port Unreachable
From 169.254.8.40 icmp_seq=3 Destination Port Unreachable
From 169.254.8.40 icmp_seq=4 Destination Port Unreachable
^C
--- 169.254.8.40 ping statistics ---
4 packets transmitted, 0 received, +4 errors, 100% packet loss, time 3003ms

root@iKuai:/root$


==== 如果不制定目标，则默认规则为该链的默认目标 ====

修改filter表INPUT链的目标为丢弃

leocheung@leocheung-CW65S:~$ sudo iptables -P INPUT DROP -t filter
leocheung@leocheung-CW65S:~$ sudo iptables -t filter -L INPUT -nv --line
Chain INPUT (policy DROP 27 packets, 3140 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        0     0 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:53
2        0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:53
3        0     0 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:67
4        0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:67
5    58200   77M ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           
6        0     0            icmp --  br+    *       0.0.0.0/0            0.0.0.0/0           
leocheung@leocheung-CW65S:~$

从对端发起ping命令，全都被丢弃

root@iKuai:/root$ping 169.254.8.40
PING 169.254.8.40 (169.254.8.40) 56(84) bytes of data.
^C
--- 169.254.8.40 ping statistics ---
3 packets transmitted, 0 received, 100% packet loss, time 2000ms

root@iKuai:/root$

将再将链的默认目标变为接受，记录已经变过来了，另外条目的匹配记录也显示为三条，刚ping包全部匹配到了

leocheung@leocheung-CW65S:~$ sudo iptables -P INPUT ACCEPT -t filter
leocheung@leocheung-CW65S:~$ sudo iptables -t filter -L INPUT -nv --line
Chain INPUT (policy ACCEPT 48 packets, 6542 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        0     0 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:53
2        0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:53
3        0     0 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:67
4        0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:67
5    89516  118M ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           
6        3   252            icmp --  br+    *       0.0.0.0/0            0.0.0.0/0           
leocheung@leocheung-CW65S:~$

在发起ping命令，全部成功了，执行了通过

root@iKuai:/root$ping 169.254.8.40
PING 169.254.8.40 (169.254.8.40) 56(84) bytes of data.
64 bytes from 169.254.8.40: icmp_req=1 ttl=64 time=0.362 ms
64 bytes from 169.254.8.40: icmp_req=2 ttl=64 time=0.573 ms
64 bytes from 169.254.8.40: icmp_req=3 ttl=64 time=0.646 ms
^C
--- 169.254.8.40 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2001ms
rtt min/avg/max/mdev = 0.362/0.527/0.646/0.120 ms

查看记录情况为在先前的记录上又匹配到了三条记录：

leocheung@leocheung-CW65S:~$ sudo iptables -t filter -L INPUT -nv --line
Chain INPUT (policy ACCEPT 48 packets, 6542 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        0     0 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:53
2        0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:53
3        0     0 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:67
4        0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:67
5    89516  118M ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           
6        3   252            icmp --  br+    *       0.0.0.0/0            0.0.0.0/0           
leocheung@leocheung-CW65S:~$


==== iptable -o ====

leo@HP:~/source/ikuai_gitsrc$ sudo iptables -t filter -A OUTPUT -p icmp -s 192.168.100.1 -j REJECT
leo@HP:~/source/ikuai_gitsrc$ ping 192.168.100.204
PING 192.168.100.204 (192.168.100.204) 56(84) bytes of data.
ping: sendmsg: 不允许的操作
ping: sendmsg: 不允许的操作
ping: sendmsg: 不允许的操作
^C
--- 192.168.100.204 ping statistics ---
3 packets transmitted, 0 received, 100% packet loss, time 2046ms

leo@HP:~/source/ikuai_gitsrc$ sudo iptables -t filter -L OUTPUT -vn
Chain OUTPUT (policy ACCEPT 18 packets, 2975 bytes)
 pkts bytes target     prot opt in     out     source               destination         
   25  8260 ACCEPT     udp  --  *      virbr0  0.0.0.0/0            0.0.0.0/0            udp dpt:68
    6   588 REJECT     icmp --  *      *       192.168.100.1        0.0.0.0/0            reject-with icmp-port-unreachable
leo@HP:~/source/ikuai_gitsrc$ sudo iptables -t filter -D OUTPUT -p icmp -s 192.168.100.1 -j REJECT
leo@HP:~/source/ikuai_gitsrc$ ping 192.168.100.204
PING 192.168.100.204 (192.168.100.204) 56(84) bytes of data.
64 bytes from 192.168.100.204: icmp_seq=1 ttl=64 time=0.840 ms
64 bytes from 192.168.100.204: icmp_seq=2 ttl=64 time=0.285 ms
^C
--- 192.168.100.204 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1001ms
rtt min/avg/max/mdev = 0.285/0.562/0.840/0.278 ms
leo@HP:~/source/ikuai_gitsrc$ sudo iptables -t filter -L OUTPUT -vn
Chain OUTPUT (policy ACCEPT 13 packets, 1402 bytes)
 pkts bytes target     prot opt in     out     source               destination         
   25  8260 ACCEPT     udp  --  *      virbr0  0.0.0.0/0            0.0.0.0/0            udp dpt:68
leo@HP:~/source/ikuai_gitsrc$ 

==== iptables-extensions -m multiport for multiple port ====

leo@HP:~$ sudo iptables -A INPUT -t filter -p tcp -m tcp -m multiport --port 80,443 -j REJECT
leo@HP:~$ sudo iptables -L INPUT -t filter -nv
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:53
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:53
    0     0 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:67
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:67
    2   120 REJECT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp multiport ports 80,443 reject-with icmp-port-unreachable
leo@HP:~$ curl https://www.baidu.com
^C
leo@HP:~$ curl www.hao123.com
^C
leo@HP:~$ sudo iptables -D INPUT -t filter -p tcp -m tcp -m multiport --port 80,443 -j REJECT
leo@HP:~$ curl www.hao123.com |wc -l
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  384k    0  384k    0     0  1472k      0 --:--:-- --:--:-- --:--:-- 1472k
194
leo@HP:~$ curl https://www.baidu.com |wc -l
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  2443  100  2443    0     0  28080      0 --:--:-- --:--:-- --:--:-- 28080
3
leo@HP:~$ 

==== iptable -m comment ====

leo@HP:~/tmp/gittest/git3$ sudo iptables -A INPUT -t filter -p icmp  -m comment --comment "icmp myself" -j REJECT
leo@HP:~/tmp/gittest/git3$ sudo iptables -L INPUT -t filter -nv
Chain INPUT (policy ACCEPT 21 packets, 1971 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:53
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:53
    0     0 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:67
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:67
    0     0 REJECT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0            /* icmp myself */ reject-with icmp-port-unreachable
leo@HP:~/tmp/gittest/git3$ 

==== iptables -m iprange ====

设置ip范围规则
leo@HP:~/tmp/gittest/git3$ sudo iptables -t filter -A INPUT -m iprange --src-range 192.168.100.204-192.168.100.225 -j REJECT
leo@HP:~/tmp/gittest/git3$ sudo iptables -t filter -L INPUT --line
Chain INPUT (policy ACCEPT)
num  target     prot opt source               destination         
1    ACCEPT     udp  --  anywhere             anywhere             udp dpt:domain
2    ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:domain
3    ACCEPT     udp  --  anywhere             anywhere             udp dpt:bootps
4    ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:bootps
5    REJECT     all  --  anywhere             anywhere             source IP range 192.168.100.204-192.168.100.225 reject-with icmp-port-unreachable
leo@HP:~/tmp/gittest/git3$

从以下两个虚拟机分别ping主机：

root@OpenWrt:/# ping 192.168.100.1
PING 192.168.100.1 (192.168.100.1): 56 data bytes
^C
--- 192.168.100.1 ping statistics ---
2 packets transmitted, 0 packets received, 100% packet loss
root@OpenWrt:/# ip addr show br-lan
4: br-lan: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP qlen 1000
    link/ether 52:54:00:20:04:67 brd ff:ff:ff:ff:ff:ff
    inet 192.168.100.225/24 brd 192.168.100.255 scope global br-lan
       valid_lft forever preferred_lft forever
    inet6 fe80::5054:ff:fe20:467/64 scope link 
       valid_lft forever preferred_lft forever
root@OpenWrt:/# 

root@OpenWrt:/# ping 192.168.100.1
PING 192.168.100.1 (192.168.100.1): 56 data bytes
^C
--- 192.168.100.1 ping statistics ---
2 packets transmitted, 0 packets received, 100% packet loss
root@OpenWrt:/# ip addr show br-lan
4: br-lan: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP qlen 1000
    link/ether 52:54:00:bc:0a:0b brd ff:ff:ff:ff:ff:ff
    inet 192.168.100.204/24 brd 192.168.100.255 scope global br-lan
       valid_lft forever preferred_lft forever
    inet6 fe80::5054:ff:febc:a0b/64 scope link 
       valid_lft forever preferred_lft forever
root@OpenWrt:/# 

查看包的状态，已经匹配并且拦截到包了

leo@HP:~/source/ikuai_gitsrc_ssh/iptables$ sudo iptables -t filter -L INPUT --line -vn
Chain INPUT (policy ACCEPT 165 packets, 22765 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1       28  1904 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:53
2        0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:53
3       26  8528 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:67
4        0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:67
5        9   756 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            source IP range 192.168.100.204-192.168.100.225 reject-with icmp-port-unreachable

删掉规则：

leo@HP:~/source/ikuai_gitsrc_ssh/iptables$ sudo iptables -t filter -D INPUT -m iprange --src-range 192.168.100.204-192.168.100.225 -j REJECT
leo@HP:~/source/ikuai_gitsrc_ssh/iptables$ sudo iptables -t filter -L INPUT --line -vn
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1       28  1904 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:53
2        0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:53
3       26  8528 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:67
4        0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:67
leo@HP:~/source/ikuai_gitsrc_ssh/iptables$

root@OpenWrt:/# ping 192.168.100.1
PING 192.168.100.1 (192.168.100.1): 56 data bytes
64 bytes from 192.168.100.1: seq=0 ttl=64 time=0.945 ms
64 bytes from 192.168.100.1: seq=1 ttl=64 time=0.673 ms
^C
--- 192.168.100.1 ping statistics ---
2 packets transmitted, 2 packets received, 0% packet loss
round-trip min/avg/max = 0.673/0.809/0.945 ms
root@OpenWrt:/# 

root@OpenWrt:/# ping 192.168.100.1
PING 192.168.100.1 (192.168.100.1): 56 data bytes
64 bytes from 192.168.100.1: seq=0 ttl=64 time=0.388 ms
64 bytes from 192.168.100.1: seq=1 ttl=64 time=0.759 ms
^C
--- 192.168.100.1 ping statistics ---
2 packets transmitted, 2 packets received, 0% packet loss
round-trip min/avg/max = 0.388/0.573/0.759 ms
root@OpenWrt:/# 

再从两个虚拟机ping主机，均正常

==== iptables -m string --string pattern ====

设置过滤包的关键字

leo@HP:~$ sudo iptables -A INPUT -t filter -m string --algo bm --string abcd -j REJECT
leo@HP:~$ sudo iptables -L INPUT -t filter -vn
Chain INPUT (policy ACCEPT 10 packets, 2398 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:53
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:53
    0     0 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:67
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:67
    0     0 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            STRING match  "abcd" ALGO name bm TO 65535 reject-with icmp-port-unreachable

netcat工具模拟服务器
leo@HP:~$ netcat -l 8000
1234
^C

netcat工具模拟客户端
leo@HP:~$ nc 127.0.0.1 8000
1234
abcd
^C

结果是abcd的包发不过去

查看规则的匹配情况，重复发了很多次

leo@HP:~$ sudo iptables -L INPUT -t filter -vn
Chain INPUT (policy ACCEPT 41 packets, 6299 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:53
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:53
    0     0 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:67
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:67
   26  1846 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            STRING match  "abcd" ALGO name bm TO 65535 reject-with icmp-port-unreachable
leo@HP:~$ 


==== iptables -m limit ====

leo@HP:~$ sudo iptables -t filter -A INPUT -m limit --limit 10/minute --limit-burst 5 -p icmp --source 192.168.124.8 -j ACCEPT 
leo@HP:~$ sudo iptables -t filter -A INPUT -p icmp -j REJECT
leo@HP:~$ sudo iptables -t filter -L INPUT -nv --line
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        0     0 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:53
2        0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:53
3        0     0 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:67
4        0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:67
5        0     0 ACCEPT     icmp --  *      *       192.168.124.8        0.0.0.0/0            limit: avg 10/min burst 5
6        0     0 REJECT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable
leo@HP:~$ sudo iptables -t filter -L INPUT -nv --line
Chain INPUT (policy ACCEPT 8 packets, 1127 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        0     0 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:53
2        0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:53
3        0     0 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:67
4        0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:67
5        6   504 ACCEPT     icmp --  *      *       192.168.124.8        0.0.0.0/0            limit: avg 10/min burst 5
6       10   980 REJECT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable
leo@HP:~$ 

leo@HP:~$ ping 192.168.124.8
PING 192.168.124.8 (192.168.124.8) 56(84) bytes of data.
64 bytes from 192.168.124.8: icmp_seq=1 ttl=64 time=0.111 ms
64 bytes from 192.168.124.8: icmp_seq=2 ttl=64 time=0.092 ms
^C
--- 192.168.124.8 ping statistics ---
7 packets transmitted, 2 received, 71% packet loss, time 6120ms
rtt min/avg/max/mdev = 0.092/0.101/0.111/0.013 ms
leo@HP:~$

leo@HP:~$ sudo iptables -t filter -A INPUT -p icmp -m limit --limit 10/minute --limit-burst 5 -j ACCEPT
leo@HP:~$ sudo iptables -t filter -A INPUT -p icmp -j REJECT
leo@HP:~$ sudo iptables -L INPUT -vn -t filter
Chain INPUT (policy ACCEPT 12 packets, 1910 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    4   272 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:53
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:53
    5  1640 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:67
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:67
    0     0 ACCEPT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0            limit: avg 10/min burst 5
    0     0 REJECT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable
leo@HP:~$ sudo iptables -L INPUT -vn -t filter
Chain INPUT (policy ACCEPT 29 packets, 4274 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    4   272 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:53
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:53
    5  1640 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:67
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:67
    7   588 ACCEPT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0            limit: avg 10/min burst 5
    9   756 REJECT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable
leo@HP:~$ sudo iptables -L INPUT -vn -t filter
Chain INPUT (policy ACCEPT 38 packets, 5536 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    4   272 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:53
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:53
    5  1640 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:67
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:67
   13  1092 ACCEPT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0            limit: avg 10/min burst 5
   23  1932 REJECT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable
leo@HP:~$ 

root@OpenWrt:/# ping 192.168.100.1
PING 192.168.100.1 (192.168.100.1): 56 data bytes
64 bytes from 192.168.100.1: seq=0 ttl=64 time=0.388 ms
64 bytes from 192.168.100.1: seq=1 ttl=64 time=0.457 ms
64 bytes from 192.168.100.1: seq=2 ttl=64 time=0.571 ms
64 bytes from 192.168.100.1: seq=3 ttl=64 time=0.463 ms
64 bytes from 192.168.100.1: seq=4 ttl=64 time=0.551 ms
64 bytes from 192.168.100.1: seq=6 ttl=64 time=0.556 ms
64 bytes from 192.168.100.1: seq=12 ttl=64 time=0.522 ms
^C
--- 192.168.100.1 ping statistics ---
16 packets transmitted, 7 packets received, 56% packet loss
round-trip min/avg/max = 0.388/0.501/0.571 ms
root@OpenWrt:/# ping 192.168.100.1
PING 192.168.100.1 (192.168.100.1): 56 data bytes
64 bytes from 192.168.100.1: seq=0 ttl=64 time=0.345 ms
64 bytes from 192.168.100.1: seq=1 ttl=64 time=0.609 ms
64 bytes from 192.168.100.1: seq=2 ttl=64 time=0.643 ms
64 bytes from 192.168.100.1: seq=4 ttl=64 time=0.579 ms
64 bytes from 192.168.100.1: seq=10 ttl=64 time=0.542 ms
64 bytes from 192.168.100.1: seq=16 ttl=64 time=0.570 ms
64 bytes from 192.168.100.1: seq=22 ttl=64 time=0.601 ms
^C
--- 192.168.100.1 ping statistics ---
27 packets transmitted, 7 packets received, 74% packet loss
round-trip min/avg/max = 0.345/0.555/0.643 ms
root@OpenWrt:/# 

==== iptable -m tcp --tcp-flags ====
sudo iptables -A INPUT -p tcp --tcp-flags SYN,ACK,FIN,RST SYN --dport 8800 -j REJECT
leo@HP:~$ netcat -l 8801
leo@HP:~$ netcat -vz 127.0.0.1 8801
Connection to 127.0.0.1 8801 port [tcp/*] succeeded!
leo@HP:~$ netcat -l 8800
^C
leo@HP:~$ netcat -vz 127.0.0.1 8800
netcat: connect to 127.0.0.1 port 8800 (tcp) failed: Connection refused
leo@HP:~$ netstat -apnt |grep 8800
（并非所有进程都能被检测到，所有非本用户的进程信息将不会显示，如果想看到所有信息，则必须切换到 root 用户）
tcp        0      0 0.0.0.0:8800            0.0.0.0:*               LISTEN      3529/netcat    

leo@HP:~$ sudo iptables -L INPUT -t filter -v
Chain INPUT (policy ACCEPT 127 packets, 8475 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 ACCEPT     udp  --  virbr0 any     anywhere             anywhere             udp dpt:domain
    0     0 ACCEPT     tcp  --  virbr0 any     anywhere             anywhere             tcp dpt:domain
    0     0 ACCEPT     udp  --  virbr0 any     anywhere             anywhere             udp dpt:bootps
    0     0 ACCEPT     tcp  --  virbr0 any     anywhere             anywhere             tcp dpt:bootps
    4   240 REJECT     tcp  --  any    any     anywhere             anywhere             tcp dpt:8800 flags:FIN,SYN,RST,ACK/SYN reject-with icmp-port-unreachable
leo@HP:~$ 

--syn = --tcp-flags SYN,ACK,FIN,RST SYN
leo@HP:~$ sudo iptables -A INPUT -p tcp  --syn --dport 8801 -j REJECT
leo@HP:~$ sudo iptables -L INPUT -t filter -v
Chain INPUT (policy ACCEPT 1 packets, 216 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 ACCEPT     udp  --  virbr0 any     anywhere             anywhere             udp dpt:domain
    0     0 ACCEPT     tcp  --  virbr0 any     anywhere             anywhere             tcp dpt:domain
    0     0 ACCEPT     udp  --  virbr0 any     anywhere             anywhere             udp dpt:bootps
    0     0 ACCEPT     tcp  --  virbr0 any     anywhere             anywhere             tcp dpt:bootps
    4   240 REJECT     tcp  --  any    any     anywhere             anywhere             tcp dpt:8800 flags:FIN,SYN,RST,ACK/SYN reject-with icmp-port-unreachable
    0     0 REJECT     tcp  --  any    any     anywhere             anywhere             tcp dpt:8801 flags:FIN,SYN,RST,ACK/SYN reject-with icmp-port-unreachable


==== iptables -m icmp --icmp-type ====

leo@HP:~$ sudo iptables -A INPUT -t filter -p icmp -m icmp --icmp-type echo-request -j REJECT
leo@HP:~$ sudo iptables -L INPUT -t filter -vn
Chain INPUT (policy ACCEPT 1 packets, 216 bytes)
 pkts bytes target     prot opt in     out     source               destination         
   11   748 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:53
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:53
    4  1312 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:67
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:67
    0     0 REJECT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0            icmptype 8 reject-with icmp-port-unreachable


另一台主机地址：

4: br-lan: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP qlen 1000
    link/ether 52:54:00:20:04:67 brd ff:ff:ff:ff:ff:ff
    inet 192.168.100.225/24 brd 192.168.100.255 scope global br-lan
       valid_lft forever preferred_lft forever
    inet6 fe80::5054:ff:fe20:467/64 scope link 

在另一台主机上ping：
root@OpenWrt:/# ping 192.168.100.1
PING 192.168.100.1 (192.168.100.1): 56 data bytes
^C
--- 192.168.100.1 ping statistics ---
5 packets transmitted, 0 packets received, 100% packet loss
root@OpenWrt:/#

查看结果：
leo@HP:~$ sudo iptables -L INPUT -t filter -vn
Chain INPUT (policy ACCEPT 39 packets, 4162 bytes)
 pkts bytes target     prot opt in     out     source               destination         
   11   748 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:53
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:53
    4  1312 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:67
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:67
    5   420 REJECT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0            icmptype 8 reject-with icmp-port-unreachable

换个另外风格的同意义参数设置：

leo@HP:~$ sudo iptables -A INPUT -t filter -p icmp -m icmp --icmp-type 8/0 -j REJECT
leo@HP:~$ sudo iptables -D INPUT -t filter -p icmp -m icmp --icmp-type echo-request -j REJECT
leo@HP:~$ sudo iptables -L INPUT -t filter -vn
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
   11   748 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:53
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:53
    4  1312 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:67
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:67
    0     0 REJECT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0            icmptype 8 code 0 reject-with icmp-port-unreachable

结果仍然生效：

root@OpenWrt:/# ping 192.168.100.1
PING 192.168.100.1 (192.168.100.1): 56 data bytes
^C
--- 192.168.100.1 ping statistics ---
3 packets transmitted, 0 packets received, 100% packet loss
root@OpenWrt:/#

leo@HP:~$ sudo iptables -L INPUT -t filter -vn
Chain INPUT (policy ACCEPT 5 packets, 739 bytes)
 pkts bytes target     prot opt in     out     source               destination         
   11   748 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:53
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:53
    4  1312 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:67
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:67
    3   252 REJECT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0            icmptype 8 code 0 reject-with icmp-port-unreachable


删除并添加第三种风格同意义参数：

leo@HP:~$ sudo iptables -D INPUT -t filter -p icmp -m icmp --icmp-type 8/0 -j REJECT
leo@HP:~$ sudo iptables -A INPUT -t filter -p icmp -m icmp --icmp-type 8 -j REJECT
leo@HP:~$ sudo iptables -L INPUT -t filter -vn
Chain INPUT (policy ACCEPT 3 packets, 307 bytes)
 pkts bytes target     prot opt in     out     source               destination         
   11   748 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:53
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:53
    4  1312 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:67
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:67
    0     0 REJECT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0            icmptype 8 reject-with icmp-port-unreachable

仍然有效：

PING 192.168.100.1 (192.168.100.1): 56 data bytes
^C
--- 192.168.100.1 ping statistics ---
2 packets transmitted, 0 packets received, 100% packet loss
root@OpenWrt:/#

leo@HP:~$ sudo iptables -L INPUT -t filter -vn
Chain INPUT (policy ACCEPT 5 packets, 739 bytes)
 pkts bytes target     prot opt in     out     source               destination         
   11   748 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:53
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:53
    4  1312 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:67
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:67
    2   168 REJECT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0            icmptype 8 reject-with icmp-port-unreachable
leo@HP:~$ 

不动规则，反ping另一台主机：

leo@HP:~$ ping 192.168.100.225
PING 192.168.100.225 (192.168.100.225) 56(84) bytes of data.
64 bytes from 192.168.100.225: icmp_seq=1 ttl=64 time=0.540 ms
64 bytes from 192.168.100.225: icmp_seq=2 ttl=64 time=0.520 ms
64 bytes from 192.168.100.225: icmp_seq=3 ttl=64 time=0.520 ms
^C
--- 192.168.100.225 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2025ms
rtt min/avg/max/mdev = 0.520/0.526/0.540/0.028 ms
leo@HP:~$ 

=== iptables -m state ====

eo@HP:~$ sudo iptables -A INPUT -t filter -m state --state RELATED,ESTABLISHED -j ACCEPT
leo@HP:~$ sudo iptables -A INPUT -t filter -j REJECT
leo@HP:~$ sudo iptables -L INPUT -t filter -vn --line
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1       29  1972 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:53
2        0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:53
3       12  3936 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:67
4        0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:67
5        0     0 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            state RELATED,ESTABLISHED
6        1   216 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable
leo@HP:~$ netstat -antp |grep 22
（并非所有进程都能被检测到，所有非本用户的进程信息将不会显示，如果想看到所有信息，则必须切换到 root 用户）
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -                   
tcp        0      0 192.168.124.8:22        192.168.124.12:45674    ESTABLISHED -                   
tcp6       0      0 :::22                   :::*                    LISTEN      -                   
leo@HP:~$ 
leo@HP:~$ 
leo@HP:~$ sudo iptables -L INPUT -t filter -vn --line
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1       29  1972 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:53
2        0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:53
3       12  3936 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:67
4        0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:67
5       87  7811 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            state RELATED,ESTABLISHED
6      139 13781 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable
leo@HP:~$ sudo iptables -L INPUT -t filter -vn --line
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1       29  1972 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:53
2        0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:53
3       12  3936 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:67
4        0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:67
5       88  7851 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            state RELATED,ESTABLISHED
6      155 15655 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable
leo@HP:~$ sudo iptables -D INPUT -t filter -j REJECT
leo@HP:~$ netstat -antp |grep 22
（并非所有进程都能被检测到，所有非本用户的进程信息将不会显示，如果想看到所有信息，则必须切换到 root 用户）
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -                   
tcp        0      0 192.168.124.8:22        192.168.124.12:45674    ESTABLISHED -                   
tcp6       0      0 :::22                   :::*                    LISTEN      -                   
leo@HP:~$ 

其中192.168.124.12的主机与我本机的链接并未断开，但通信命令也无法正常进行，被阻塞住，先存疑此处


==== iptables create new chain ====

预先通过web所在主机的两个ip进行测试，均可以访问到页面

leo@HP:~$ curl 192.168.2.105
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="refresh" content="0; URL=cgi-bin/luci/" />
</head>
<body style="background-color: white">
<a style="color: black; font-family: arial, helvetica, sans-serif;" href="cgi-bin/luci/">LuCI - Lua Configuration Interface</a>
</body>
</html>
leo@HP:~$ curl 192.168.100.3
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="refresh" content="0; URL=cgi-bin/luci/" />
</head>
<body style="background-color: white">
<a style="color: black; font-family: arial, helvetica, sans-serif;" href="cgi-bin/luci/">LuCI - Lua Configuration Interface</a>
</body>
</html>
leo@HP:~$ netstat -apnt |grep 80
（并非所有进程都能被检测到，所有非本用户的进程信息将不会显示，如果想看到所有信息，则必须切换到 root 用户）
tcp        0      0 192.168.100.1:43108     192.168.100.3:80        TIME_WAIT   -                   
tcp        0      0 192.168.2.102:54608     111.30.169.23:8080      ESTABLISHED 5641/qq             
leo@HP:~$

创建新链：

leo@HP:~$ sudo iptables -N WEB80 -t filter
leo@HP:~$ sudo iptables -t filter -L WEB80
Chain WEB80 (0 references)
target     prot opt source               destination         

给新链调价规则：

leo@HP:~$ sudo iptables -t filter -A WEB80 -s 192.168.100.0/24 -j ACCEPT
leo@HP:~$ sudo iptables -t filter -A WEB80 -j REJECT
leo@HP:~$ sudo iptables -t filter -L WEB80
Chain WEB80 (0 references)
target     prot opt source               destination         
ACCEPT     all  --  192.168.100.0/24     anywhere            
REJECT     all  --  anywhere             anywhere             reject-with icmp-port-unreachable

将内置的链的执行规则目标，指向自定义链：
leo@HP:~$ sudo iptables -t filter -A INPUT -p tcp --dport 80 -j WEB80
leo@HP:~$ sudo iptables -t filter -A INPUT -p tcp --sport 80 -j WEB80
leo@HP:~$ sudo iptables -t filter -L INPUT -vn
Chain INPUT (policy ACCEPT 6 packets, 1487 bytes)
 pkts bytes target     prot opt in     out     source               destination         
   29  1972 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:53
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:53
   12  3936 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:67
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:67
    0     0 WEB80      tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80
    0     0 WEB80      tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp spt:80


发送通过规则的请求：

leo@HP:~$ curl 192.168.100.3
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="refresh" content="0; URL=cgi-bin/luci/" />
</head>
<body style="background-color: white">
<a style="color: black; font-family: arial, helvetica, sans-serif;" href="cgi-bin/luci/">LuCI - Lua Configuration Interface</a>
</body>
</html>
leo@HP:~$

匹配个数：

leo@HP:~$ sudo iptables -t filter -L INPUT -vn
Chain INPUT (policy ACCEPT 22 packets, 5106 bytes)
 pkts bytes target     prot opt in     out     source               destination         
   29  1972 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:53
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:53
   12  3936 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:67
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:67
    0     0 WEB80      tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80
    8  1168 WEB80      tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp spt:80
leo@HP:~$ sudo iptables -t filter -L WEB80 -nv
Chain WEB80 (2 references)
 pkts bytes target     prot opt in     out     source               destination         
    8  1168 ACCEPT     all  --  *      *       192.168.100.0/24     0.0.0.0/0           
    0     0 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable
leo@HP:~$

发送拦截过则的请求：

leo@HP:~$ curl 192.168.2.105
^C

拦截打的规则数量增加：

leo@HP:~$ sudo iptables -t filter -L WEB80 -nv
Chain WEB80 (2 references)
 pkts bytes target     prot opt in     out     source               destination         
    8  1168 ACCEPT     all  --  *      *       192.168.100.0/24     0.0.0.0/0           
    7   420 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable
leo@HP:~$ 

==== iptables -X user defined chain ====

删除应该自定义联众没有任何规则，链没有任何引用：

从不符合的规则开始删起，顺便看提示：

直接删除提示有引用：

leo@HP:~$ sudo iptables -t filter -X WEB80
iptables: Too many links.

删除引用：

leo@HP:~$ sudo iptables -t filter -D INPUT -p tcp --sport 80 -j WEB80
leo@HP:~$ sudo iptables -t filter -D INPUT -p tcp --dport 80 -j WEB80

引用为零了，但有两条规则：

leo@HP:~$ sudo iptables -t filter -L WEB80
Chain WEB80 (0 references)
target     prot opt source               destination         
ACCEPT     all  --  192.168.100.0/24     anywhere            
REJECT     all  --  anywhere             anywhere             reject-with icmp-port-unreachable

直接删除自定义链，显示列表不空：

leo@HP:~$ sudo iptables -t filter -X WEB80
iptables: Directory not empty.

直接清空列表，并查看，为空：

leo@HP:~$ sudo iptables -t filter -F WEB80
leo@HP:~$ sudo iptables -t filter -L WEB80
Chain WEB80 (0 references)
target     prot opt source               destination         

再删除，则成功：

leo@HP:~$ sudo iptables -t filter -X WEB80

查看，不filter表中不存在引用自定义链的规则，该自定义链也已经不见被删掉了：

leo@HP:~$ sudo iptables -t filter -L
[sudo] leo 的密码： 
Chain INPUT (policy ACCEPT)
target     prot opt source               destination         
ACCEPT     udp  --  anywhere             anywhere             udp dpt:domain
ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:domain
ACCEPT     udp  --  anywhere             anywhere             udp dpt:bootps
ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:bootps

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination         
ACCEPT     all  --  anywhere             anywhere            
REJECT     all  --  anywhere             anywhere             reject-with icmp-port-unreachable
REJECT     all  --  anywhere             anywhere             reject-with icmp-port-unreachable

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination         
ACCEPT     udp  --  anywhere             anywhere             udp dpt:bootpc
leo@HP:~$

==== iptables -t filter -A FORWARD for gate way ====

mininet的网络情况：

mininet> net
h1 h1-eth0:s1-eth1
h2 h2-eth0:s1-eth2
nat0 nat0-eth0:s1-eth3
s1 lo:  s1-eth1:h1-eth0 s1-eth2:h2-eth0 s1-eth3:nat0-eth0
mininet> 

查看iptables设置
mininet> s1 iptables -t filter -L FORWARD
Chain FORWARD (policy ACCEPT)
target     prot opt source               destination         
DROP       all  --  anywhere             loaclhost/8         
ACCEPT     all  --  anywhere             anywhere            
REJECT     all  --  anywhere             anywhere             reject-with icmp-port-unreachable
REJECT     all  --  anywhere             anywhere             reject-with icmp-port-unreachable
ACCEPT     all  --  loaclhost/8          anywhere            
ACCEPT     all  --  anywhere             loaclhost/8         


网络ping命令ping外网
mininet> h1 ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=47 time=47.4 ms
64 bytes from 8.8.8.8: icmp_seq=2 ttl=47 time=45.2 ms
^C
--- 8.8.8.8 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1001ms
rtt min/avg/max/mdev = 45.277/46.357/47.438/1.101 ms

设置规则
mininet> s1 iptables -t filter -I FORWARD -j REJECT

ping不通了：

mininet> h1 ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
From 10.0.0.3 icmp_seq=1 Destination Port Unreachable
From 10.0.0.3 icmp_seq=2 Destination Port Unreachable
From 10.0.0.3 icmp_seq=3 Destination Port Unreachable
^C
--- 8.8.8.8 ping statistics ---
3 packets transmitted, 0 received, +3 errors, 100% packet loss, time 2027ms

查看iptables规则及匹配到包的情况，规则被丢弃了三个包，数量吻合：

mininet> s1 iptables -t filter -L FORWARD -vn
Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    3   252 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable
    0     0 DROP       all  --  nat0-eth0 *       0.0.0.0/0            10.0.0.0/8          
    0     0 ACCEPT     all  --  virbr0 virbr0  0.0.0.0/0            0.0.0.0/0           
    0     0 REJECT     all  --  *      virbr0  0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable
    0     0 REJECT     all  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable
    8   672 ACCEPT     all  --  nat0-eth0 *       10.0.0.0/8           0.0.0.0/0           
    8   672 ACCEPT     all  --  *      nat0-eth0  0.0.0.0/0            10.0.0.0/8          

删除规则：

mininet> s1 iptables -t filter -D FORWARD -j REJECT

再次ping外网：

mininet> h1 ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=47 time=46.0 ms
64 bytes from 8.8.8.8: icmp_seq=2 ttl=47 time=53.4 ms
^C
--- 8.8.8.8 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1001ms
rtt min/avg/max/mdev = 46.020/49.729/53.439/3.716 ms

再次查看规则，已经被删除：

mininet> s1 iptables -t filter -L FORWARD -vn
Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 DROP       all  --  nat0-eth0 *       0.0.0.0/0            10.0.0.0/8          
    0     0 ACCEPT     all  --  virbr0 virbr0  0.0.0.0/0            0.0.0.0/0           
    0     0 REJECT     all  --  *      virbr0  0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable
    0     0 REJECT     all  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable
   10   840 ACCEPT     all  --  nat0-eth0 *       10.0.0.0/8           0.0.0.0/0           
   10   840 ACCEPT     all  --  *      nat0-eth0  0.0.0.0/0            10.0.0.0/8          


==== iptable -j LOg and -j REJECT ====

leo@HP:~$ sudo iptables -t filter -A INPUT -p tcp --dport 8888 -j LOG
leo@HP:~$ sudo iptables -t filter -A INPUT -p tcp --dport 8888 -j REJECT
leo@HP:~$ sudo iptables -t filter -L INPUT -vn
Chain INPUT (policy ACCEPT 7 packets, 995 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:53
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:53
    0     0 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:67
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:67
    0     0 LOG        tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:8888 LOG flags 0 level 4
    0     0 REJECT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:8888 reject-with icmp-port-unreachable
leo@HP:~$ netcat -l 8888
^C


leo@HP:~/source/ikuai_gitsrc_ssh/iptables$ netcat 192.168.124.8 8888 -vz
netcat: connect to 192.168.124.8 port 8888 (tcp) failed: Connection refused
leo@HP:~/source/ikuai_gitsrc_ssh/iptables$ sudo cat /var/log/iptables.log 
[sudo] leo 的密码： 
May 18 23:18:08 HP kernel: [14122.226126] IN=lo OUT= MAC=00:00:00:00:00:00:00:00:00:00:00:00:08:00 SRC=192.168.124.8 DST=192.168.124.8 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=43028 DF PROTO=TCP SPT=58754 DPT=8888 WINDOW=43690 RES=0x00 SYN URGP=0 
May 18 23:18:09 HP kernel: [14123.239588] IN=lo OUT= MAC=00:00:00:00:00:00:00:00:00:00:00:00:08:00 SRC=192.168.124.8 DST=192.168.124.8 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=43029 DF PROTO=TCP SPT=58754 DPT=8888 WINDOW=43690 RES=0x00 SYN URGP=0 
May 18 23:18:23 HP kernel: [14136.314413] IN=lo OUT= MAC=00:00:00:00:00:00:00:00:00:00:00:00:08:00 SRC=192.168.124.8 DST=192.168.124.8 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=12048 DF PROTO=TCP SPT=58756 DPT=8888 WINDOW=43690 RES=0x00 SYN URGP=0 
May 18 23:18:24 HP kernel: [14137.319251] IN=lo OUT= MAC=00:00:00:00:00:00:00:00:00:00:00:00:08:00 SRC=192.168.124.8 DST=192.168.124.8 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=12049 DF PROTO=TCP SPT=58756 DPT=8888 WINDOW=43690 RES=0x00 SYN URGP=0 
leo@HP:~/source/ikuai_gitsrc_ssh/iptables$

leo@HP:~$ sudo iptables -t filter -L INPUT -vn
Chain INPUT (policy ACCEPT 285 packets, 90789 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:53
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:53
    0     0 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:67
    0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:67
    4   240 LOG        tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:8888 LOG flags 0 level 4
    4   240 REJECT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:8888 reject-with icmp-port-unreachable
leo@HP:~$ 

==== iptables -j SNAT ====

充当路由主机情况，192.168.10.0网段充当局域网，192.168.2.0网段冲淡互联网，实施上他是路由器的内网

[leo@localhost ~]$ ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 52:54:00:05:e6:fa brd ff:ff:ff:ff:ff:ff
    inet 192.168.2.111/24 brd 192.168.2.255 scope global noprefixroute dynamic eth0
       valid_lft 81541sec preferred_lft 81541sec
    inet6 fe80::89b9:ef67:e0d1:9e4d/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever
3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 52:54:00:87:0c:49 brd ff:ff:ff:ff:ff:ff
    inet 192.168.10.186/24 brd 192.168.10.255 scope global noprefixroute dynamic eth1
       valid_lft 3044sec preferred_lft 3044sec
    inet6 fe80::9627:51f1:948a:e04d/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever

默认路由走2网段，10网段为私有网段

[leo@localhost ~]$ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.2.1     0.0.0.0         UG    100    0        0 eth0
192.168.2.0     0.0.0.0         255.255.255.0   U     100    0        0 eth0
192.168.10.0    0.0.0.0         255.255.255.0   U     101    0        0 eth1
[leo@localhost ~]$ 


路由情况：

[leo@localhost ~]$ traceroute 8.8.8.8
traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets
 1  gateway (192.168.2.1)  0.635 ms  0.708 ms  0.592 ms
 2  192.168.124.1 (192.168.124.1)  4.179 ms  5.648 ms  5.629 ms
 3  192.168.1.1 (192.168.1.1)  8.356 ms  8.290 ms  8.242 ms
 4  100.111.192.1 (100.111.192.1)  18.157 ms  18.131 ms  18.301 ms
 5  221.179.159.109 (221.179.159.109)  18.266 ms 211.136.60.81 (211.136.60.81)  18.239 ms  18.470 ms
 6  * * *
 7  211.136.63.113 (211.136.63.113)  10.332 ms  20.750 ms  21.251 ms
 8  111.24.14.53 (111.24.14.53)  20.635 ms  26.953 ms  26.776 ms
 9  111.24.2.242 (111.24.2.242)  34.385 ms * 111.24.2.238 (111.24.2.238)  34.191 ms
10  221.176.27.254 (221.176.27.254)  28.769 ms  28.745 ms  28.915 ms
11  * 221.183.46.249 (221.183.46.249)  28.795 ms  22.926 ms
12  221.183.55.101 (221.183.55.101)  27.017 ms  26.901 ms 221.183.55.105 (221.183.55.105)  20.844 ms
13  223.120.22.30 (223.120.22.30)  47.762 ms  47.927 ms 223.120.22.22 (223.120.22.22)  50.670 ms
14  223.120.2.101 (223.120.2.101)  57.276 ms  57.103 ms 223.120.2.5 (223.120.2.5)  50.560 ms
15  223.120.2.118 (223.120.2.118)  47.290 ms 223.120.2.42 (223.120.2.42)  53.583 ms  49.510 ms
16  223.120.2.118 (223.120.2.118)  49.357 ms 223.119.17.154 (223.119.17.154)  54.064 ms  50.255 ms
17  10.252.202.30 (10.252.202.30)  48.353 ms loaclhost (10.252.85.158)  47.676 ms loaclhost (10.252.201.222)  49.970 ms
18  loaclhost (10.252.202.62)  51.737 ms dns.google (8.8.8.8)  53.045 ms  52.968 ms
[leo@localhost ~]$ 

[leo@localhost ~]$ sudo iptables -A POSTROUTING -t nat -s 192.168.10.0/24 -j SNAT --to-source 192.168.2.111

[leo@localhost ~]$ sudo iptables -L POSTROUTING -t nat
Chain POSTROUTING (policy ACCEPT)
target     prot opt source               destination         
POSTROUTING_direct  all  --  anywhere             anywhere            
POSTROUTING_ZONES_SOURCE  all  --  anywhere             anywhere            
POSTROUTING_ZONES  all  --  anywhere             anywhere            
SNAT       all  --  192.168.10.0/24      anywhere             to:192.168.2.111
[leo@localhost ~]$ cat /proc/sys/net/ipv4/ip_forward
1

内网主机环境：

[leo@localhost ~]$ ip addr 
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 52:54:00:42:5f:80 brd ff:ff:ff:ff:ff:ff
    inet 192.168.10.187/24 brd 192.168.10.255 scope global noprefixroute dynamic eth0
       valid_lft 3478sec preferred_lft 3478sec
    inet6 fe80::4f04:2f58:8813:ad95/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever

将网关指向充当路由器的主机：
[leo@localhost ~]$ sudo route add default gw 192.168.10.168 dev eth0
[leo@localhost ~]$ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.10.186  0.0.0.0         UG    0      0        0 eth0
192.168.10.0    0.0.0.0         255.255.255.0   U     100    0        0 eth0
[leo@localhost ~]$


在客户机上发四个ping包：

[leo@localhost ~]$ ping 192.168.2.102 -c 4
PING 192.168.2.102 (192.168.2.102) 56(84) bytes of data.
64 bytes from 192.168.2.102: icmp_seq=1 ttl=63 time=0.414 ms
64 bytes from 192.168.2.102: icmp_seq=2 ttl=63 time=1.01 ms
64 bytes from 192.168.2.102: icmp_seq=3 ttl=63 time=0.990 ms
64 bytes from 192.168.2.102: icmp_seq=4 ttl=63 time=1.03 ms

--- 192.168.2.102 ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3003ms
rtt min/avg/max/mdev = 0.414/0.863/1.033/0.259 ms
[leo@localhost ~]$ 

在路由器上看打的ip地址为192.168.10.187 > 192.168.2.102

[leo@localhost ~]$ sudo tcpdump -i eth1 icmp
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth1, link-type EN10MB (Ethernet), capture size 262144 bytes
13:12:58.622241 IP 192.168.10.187 > 192.168.2.102: ICMP echo request, id 9469, seq 1, length 64
13:12:58.622447 IP 192.168.2.102 > 192.168.10.187: ICMP echo reply, id 9469, seq 1, length 64
13:12:59.623203 IP 192.168.10.187 > 192.168.2.102: ICMP echo request, id 9469, seq 2, length 64
13:12:59.623557 IP 192.168.2.102 > 192.168.10.187: ICMP echo reply, id 9469, seq 2, length 64
13:13:00.624758 IP 192.168.10.187 > 192.168.2.102: ICMP echo request, id 9469, seq 3, length 64
13:13:00.625124 IP 192.168.2.102 > 192.168.10.187: ICMP echo reply, id 9469, seq 3, length 64
13:13:01.626193 IP 192.168.10.187 > 192.168.2.102: ICMP echo request, id 9469, seq 4, length 64
13:13:01.626577 IP 192.168.2.102 > 192.168.10.187: ICMP echo reply, id 9469, seq 4, length 64
^C
8 packets captured
8 packets received by filter
0 packets dropped by kernel
[leo@localhost ~]$ 


在路由上同一网段的主机上抓包则是隐藏了路由内部私有网络，只能看到路由的地址snat的效果：

leo@HP:~/source/ikuai_gitsrc_ssh/iptables$ sudo tcpdump -i br1 icmp -n
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on br1, link-type EN10MB (Ethernet), capture size 262144 bytes
13:12:58.650300 IP 192.168.2.111 > 192.168.2.102: ICMP echo request, id 9469, seq 1, length 64
13:12:58.650334 IP 192.168.2.102 > 192.168.2.111: ICMP echo reply, id 9469, seq 1, length 64
13:12:59.651330 IP 192.168.2.111 > 192.168.2.102: ICMP echo request, id 9469, seq 2, length 64
13:12:59.651421 IP 192.168.2.102 > 192.168.2.111: ICMP echo reply, id 9469, seq 2, length 64
13:13:00.652912 IP 192.168.2.111 > 192.168.2.102: ICMP echo request, id 9469, seq 3, length 64
13:13:00.652982 IP 192.168.2.102 > 192.168.2.111: ICMP echo reply, id 9469, seq 3, length 64
13:13:01.654323 IP 192.168.2.111 > 192.168.2.102: ICMP echo request, id 9469, seq 4, length 64
13:13:01.654411 IP 192.168.2.102 > 192.168.2.111: ICMP echo reply, id 9469, seq 4, length 64

查看路由上snat规则显示的规则匹配数量：

[leo@localhost ~]$ sudo iptables -L POSTROUTING -t nat -vn
Chain POSTROUTING (policy ACCEPT 19 packets, 1349 bytes)
 pkts bytes target     prot opt in     out     source               destination         
  268 19823 POSTROUTING_direct  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
  268 19823 POSTROUTING_ZONES_SOURCE  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
  268 19823 POSTROUTING_ZONES  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    7   832 SNAT       all  --  *      *       192.168.10.0/24      0.0.0.0/0            to:192.168.2.111
[leo@localhost ~]$ 

==== iptables -j DNAT =====

没有添加规则之前服务器：
[leo@localhost ~]$ nc -l 8800
^C
[leo@localhost ~]$

客户端：
leo@HP:~/source/ikuai_gitsrc_ssh/iptables$ netcat 192.168.2.111 8800
leo@HP:~/source/ikuai_gitsrc_ssh/iptables$ netcat 192.168.2.111 8800 -vz
netcat: connect to 192.168.2.111 port 8800 (tcp) failed: Connection refused

添加规则：


[leo@localhost ~]$ sudo iptables -A PREROUTING -t nat -d 192.168.2.111 -p tcp --dport 8800 -j DNAT --to-destination 192.168.10.187:8800
[leo@localhost ~]$ sudo iptables -L PREROUTING -t nat -nv
Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
  202 46819 PREROUTING_direct  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
  202 46819 PREROUTING_ZONES_SOURCE  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
  202 46819 PREROUTING_ZONES  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    0     0 DNAT       tcp  --  *      *       0.0.0.0/0            192.168.2.111        tcp dpt:8800 to:192.168.10.187:8800

再次尝试连接：

先扫描端口
服务器开启：

[leo@localhost ~]$ nc -l 8800
[leo@localhost ~]$ 

客户端扫描：

leo@HP:~/source/ikuai_gitsrc_ssh/iptables$ netcat 192.168.2.111 8800 -vz
Connection to 192.168.2.111 8800 port [tcp/*] succeeded!
leo@HP:~/source/ikuai_gitsrc_ssh/iptables$ 

链接后交互些文本内容：


服务器：


[leo@localhost ~]$ nc -l 8800
are you 192.168.2.111
yes,I am, and I am actually 192.168.10.187
[leo@localhost ~]$ [leo@localhost ~]$

客户端：
leo@HP:~/source/ikuai_gitsrc_ssh/iptables$ netcat 192.168.2.111 8800
are you 192.168.2.111
yes,I am, and I am actually 192.168.10.187
^C
leo@HP:~/source/ikuai_gitsrc_ssh/iptables$

查看规则被匹配情况：

[leo@localhost ~]$ sudo iptables -L PREROUTING -t nat -nv
[sudo] password for leo: 
Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
  204 46939 PREROUTING_direct  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
  204 46939 PREROUTING_ZONES_SOURCE  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
  204 46939 PREROUTING_ZONES  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    2   120 DNAT       tcp  --  *      *       0.0.0.0/0            192.168.2.111        tcp dpt:8800 to:192.168.10.187:8800
[leo@localhost ~]$ 

删除规则后再次重新验证：

[leo@localhost ~]$ sudo iptables -D PREROUTING -t nat -d 192.168.2.111 -p tcp --dport 8800 -j DNAT --to-destination 192.168.10.187:8800
[leo@localhost ~]$ sudo iptables -L PREROUTING -t nat -nv
Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
  204 46939 PREROUTING_direct  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
  204 46939 PREROUTING_ZONES_SOURCE  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
  204 46939 PREROUTING_ZONES  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
[leo@localhost ~]$ 

服务器：
[leo@localhost ~]$ nc -l 8800

客户端：

leo@HP:~/source/ikuai_gitsrc_ssh/iptables$ netcat 192.168.2.111 8800 -vz
netcat: connect to 192.168.2.111 port 8800 (tcp) failed: Connection refused
leo@HP:~/source/ikuai_gitsrc_ssh/iptables$ 

==== iptables -j REDIRECT ====

服务器端：

[leo@localhost ~]$ ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 52:54:00:05:e6:fa brd ff:ff:ff:ff:ff:ff
    inet 192.168.2.111/24 brd 192.168.2.255 scope global noprefixroute dynamic eth0
       valid_lft 76978sec preferred_lft 76978sec
    inet6 fe80::89b9:ef67:e0d1:9e4d/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever
3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 52:54:00:87:0c:49 brd ff:ff:ff:ff:ff:ff
    inet 192.168.10.186/24 brd 192.168.10.255 scope global noprefixroute dynamic eth1
       valid_lft 3341sec preferred_lft 3341sec
    inet6 fe80::9627:51f1:948a:e04d/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever

[leo@localhost ~]$ sudo iptables -A PREROUTING -t nat -p tcp --dport 7700 -j REDIRECT --to-ports 8800
[leo@localhost ~]$ sudo iptables -L PREROUTING -t nat -vn
Chain PREROUTING (policy ACCEPT 21 packets, 7450 bytes)
 pkts bytes target     prot opt in     out     source               destination         
  273 69615 PREROUTING_direct  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
  273 69615 PREROUTING_ZONES_SOURCE  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
  273 69615 PREROUTING_ZONES  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    0     0 REDIRECT   tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:7700 redir ports 8800

[leo@localhost ~]$ nc -l 8800
are you 7700?
no, I am 8800!
^C


客户端：
leo@HP:~/source/ikuai_gitsrc_ssh/iptables$ netcat 192.168.2.111 7700
are you 7700?
no, I am 8800!
^C

查看匹配情况：
[leo@localhost ~]$ sudo iptables -L PREROUTING -t nat -vn
Chain PREROUTING (policy ACCEPT 21 packets, 7450 bytes)
 pkts bytes target     prot opt in     out     source               destination         
  274 69675 PREROUTING_direct  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
  274 69675 PREROUTING_ZONES_SOURCE  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
  274 69675 PREROUTING_ZONES  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    1    60 REDIRECT   tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:7700 redir ports 8800
[leo@localhost ~]$ 

查看客户端进程链接状态：
leo@HP:~/source/ikuai_gitsrc_ssh/iptables$ netstat -apnt |grep 7700
（并非所有进程都能被检测到，所有非本用户的进程信息将不会显示，如果想看到所有信息，则必须切换到 root 用户）
tcp        0      0 192.168.2.102:48336     192.168.2.111:7700      ESTABLISHED 21280/netcat        
leo@HP:~/source/ikuai_gitsrc_ssh/iptables$ 

查看服务器进程链接状态：
[leo@localhost ~]$ netstat -aptn |grep 8800
(Not all processes could be identified, non-owned process info
 will not be shown, you would have to be root to see it all.)
tcp        0      0 192.168.2.111:8800      192.168.2.102:48354     ESTABLISHED 1660/nc             
[leo@localhost ~]$ 


==== iptables -j MASQUERADE ====


-s为需要伪装的ip地址段，-o为该地址段要转发出去的端口，即从-s段的ip伪装成-o所在的网卡地址发出去
[leo@localhost ~]$ sudo iptables -t nat -A POSTROUTING -s 192.168.10.0/24 -o eth0 -j MASQUERADE
[leo@localhost ~]$ sudo iptables -t nat -L POSTROUTING -vn --line
Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        0     0 POSTROUTING_direct  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
2        0     0 POSTROUTING_ZONES_SOURCE  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
3        0     0 POSTROUTING_ZONES  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
4        0     0 MASQUERADE  all  --  *      eth0    192.168.10.0/24      0.0.0.0/0           
[leo@localhost ~]$

客户终端：

环境：
[leo@localhost ~]$ ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 52:54:00:42:5f:80 brd ff:ff:ff:ff:ff:ff
    inet 192.168.10.187/24 brd 192.168.10.255 scope global noprefixroute dynamic eth0
       valid_lft 3282sec preferred_lft 3282sec
    inet6 fe80::4f04:2f58:8813:ad95/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever
[leo@localhost ~]$ 

发起ping命令：
[leo@localhost ~]$ ping 192.168.2.102 -c 4
PING 192.168.2.102 (192.168.2.102) 56(84) bytes of data.
64 bytes from 192.168.2.102: icmp_seq=1 ttl=63 time=0.602 ms
64 bytes from 192.168.2.102: icmp_seq=2 ttl=63 time=1.24 ms
64 bytes from 192.168.2.102: icmp_seq=3 ttl=63 time=1.18 ms
64 bytes from 192.168.2.102: icmp_seq=4 ttl=63 time=1.03 ms

--- 192.168.2.102 ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3003ms
rtt min/avg/max/mdev = 0.602/1.017/1.247/0.252 ms
[leo@localhost ~]$ 

路由器所在主机发出包的网卡及转发包的网卡抓包：分别没有伪装之前的，和被伪装之后的：

[leo@localhost ~]$ sudo tcpdump -i eth0 icmp -n
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes
17:46:19.346750 IP 192.168.2.111 > 192.168.2.102: ICMP echo request, id 1608, seq 1, length 64
17:46:19.346866 IP 192.168.2.102 > 192.168.2.111: ICMP echo reply, id 1608, seq 1, length 64
17:46:20.347524 IP 192.168.2.111 > 192.168.2.102: ICMP echo request, id 1608, seq 2, length 64
17:46:20.347910 IP 192.168.2.102 > 192.168.2.111: ICMP echo reply, id 1608, seq 2, length 64
17:46:21.349202 IP 192.168.2.111 > 192.168.2.102: ICMP echo request, id 1608, seq 3, length 64
17:46:21.349469 IP 192.168.2.102 > 192.168.2.111: ICMP echo reply, id 1608, seq 3, length 64
17:46:22.350761 IP 192.168.2.111 > 192.168.2.102: ICMP echo request, id 1608, seq 4, length 64
17:46:22.351014 IP 192.168.2.102 > 192.168.2.111: ICMP echo reply, id 1608, seq 4, length 64
^C
8 packets captured
8 packets received by filter
0 packets dropped by kernel
[leo@localhost ~]$ sudo tcpdump -i eth1 icmp -n
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth1, link-type EN10MB (Ethernet), capture size 262144 bytes
17:47:15.356286 IP 192.168.10.187 > 192.168.2.102: ICMP echo request, id 1609, seq 1, length 64
17:47:15.356530 IP 192.168.2.102 > 192.168.10.187: ICMP echo reply, id 1609, seq 1, length 64
17:47:16.357496 IP 192.168.10.187 > 192.168.2.102: ICMP echo request, id 1609, seq 2, length 64
17:47:16.357932 IP 192.168.2.102 > 192.168.10.187: ICMP echo reply, id 1609, seq 2, length 64
17:47:17.359222 IP 192.168.10.187 > 192.168.2.102: ICMP echo request, id 1609, seq 3, length 64
17:47:17.359608 IP 192.168.2.102 > 192.168.10.187: ICMP echo reply, id 1609, seq 3, length 64
17:47:18.360770 IP 192.168.10.187 > 192.168.2.102: ICMP echo request, id 1609, seq 4, length 64
17:47:18.361141 IP 192.168.2.102 > 192.168.10.187: ICMP echo reply, id 1609, seq 4, length 64
^C
8 packets captured
8 packets received by filter
0 packets dropped by kernel
[leo@localhost ~]$

ping命令接受端抓包，和被伪装后的一致：

leo@HP:~/source/ikuai_gitsrc_ssh/iptables$ sudo tcpdump -i  br1 icmp -n
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on br1, link-type EN10MB (Ethernet), capture size 262144 bytes
17:46:19.344925 IP 192.168.2.111 > 192.168.2.102: ICMP echo request, id 1608, seq 1, length 64
17:46:19.344965 IP 192.168.2.102 > 192.168.2.111: ICMP echo reply, id 1608, seq 1, length 64
17:46:20.345796 IP 192.168.2.111 > 192.168.2.102: ICMP echo request, id 1608, seq 2, length 64
17:46:20.345913 IP 192.168.2.102 > 192.168.2.111: ICMP echo reply, id 1608, seq 2, length 64
17:46:21.347404 IP 192.168.2.111 > 192.168.2.102: ICMP echo request, id 1608, seq 3, length 64
17:46:21.347507 IP 192.168.2.102 > 192.168.2.111: ICMP echo reply, id 1608, seq 3, length 64
17:46:22.348966 IP 192.168.2.111 > 192.168.2.102: ICMP echo request, id 1608, seq 4, length 64
17:46:22.349063 IP 192.168.2.102 > 192.168.2.111: ICMP echo reply, id 1608, seq 4, length 64
^C
8 packets captured
8 packets received by filter
0 packets dropped by kernel
leo@HP:~/source/ikuai_gitsrc_ssh/iptables$

==== SNAT 将主机设置成路由 ====
==== 1.开启转发 ====
echo net.ipv4.ip_forward=1 >> /etc/sysctl.conf
sysctl -p

==== 2.查看做路由的主机的ip ====
leo@vu2004:~/source$ ip -o addr show
1: lo    inet 127.0.0.1/8 scope host lo\       valid_lft forever preferred_lft forever
1: lo    inet6 ::1/128 scope host \       valid_lft forever preferred_lft forever
2: enp1s0    inet 192.168.122.63/24 brd 192.168.122.255 scope global dynamic enp1s0\       valid_lft 3212sec preferred_lft 3212sec
2: enp1s0    inet6 fe80::5054:ff:fe10:49a5/64 scope link \       valid_lft forever preferred_lft forever
3: enp2s0    inet 192.168.102.188/24 brd 192.168.102.255 scope global enp2s0\       valid_lft forever preferred_lft forever
3: enp2s0    inet6 fe80::5054:ff:fe58:ef1/64 scope link \       valid_lft forever preferred_lft forever
4: enp8s0    inet 192.168.101.207/24 brd 192.168.101.255 scope global dynamic enp8s0\       valid_lft 3331sec preferred_lft 3331sec
4: enp8s0    inet6 fe80::5054:ff:fe2b:8069/64 scope link \       valid_lft forever preferred_lft forever
leo@vu2004:~/source$

==== 3.将192.168.102.0/24网段的源ip，在执行走默认路由口从enp1s0发出的时候，执行snat，将原地址改成192.168.122.63 ====
sudo iptables -t nat -A POSTROUTING -s 192.168.102.0/24 -o enp1s0 -j SNAT --to-source 192.168.122.63

==== 4.下联在enp2s0 网段为192.168.102.0/24 的主机ip地址 ====
root@iKuai:/root$ip -o addr show
1: lo    inet 127.0.0.1/8 scope host lo\       valid_lft forever preferred_lft forever
1: lo    inet 192.0.0.0/32 scope global lo\       valid_lft forever preferred_lft forever
15: lan1    inet 192.168.101.12/24 brd 192.168.101.255 scope global lan1\       valid_lft forever preferred_lft forever
16: wan1    inet 192.168.102.237/24 brd 192.168.102.255 scope global wan1\       valid_lft forever preferred_lft forever

==== 5.ping外网 情形 ====
root@iKuai:/root$ping hao123.com -c 4
PING 39.156.68.154 (39.156.68.154) 56(84) bytes of data.
64 bytes from 39.156.68.154 (39.156.68.154): icmp_seq=1 ttl=48 time=11.1 ms
64 bytes from 39.156.68.154 (39.156.68.154): icmp_seq=2 ttl=48 time=11.0 ms
64 bytes from 39.156.68.154 (39.156.68.154): icmp_seq=3 ttl=48 time=10.7 ms
64 bytes from 39.156.68.154 (39.156.68.154): icmp_seq=4 ttl=48 time=10.6 ms

--- 39.156.68.154 ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3006ms
rtt min/avg/max/mdev = 10.592/10.863/11.100/0.210 ms

5.从路由的lan口的设备ping外网的一次，获得数据如下：
root@iKuai:/root$ping hao123.com -c 1
PING 39.156.68.154 (39.156.68.154) 56(84) bytes of data.
64 bytes from 39.156.68.154 (39.156.68.154): icmp_seq=1 ttl=48 time=25.6 ms

--- 39.156.68.154 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 25.553/25.553/25.553/0.000 ms
root@iKuai:/root$

eo@vu2004:~/tmp$ sudo tcpdump -i any icmp -n
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on any, link-type LINUX_SLL (Linux cooked v1), capture size 262144 bytes
11:15:46.076548 IP 192.168.102.237 > 39.156.68.154: ICMP echo request, id 50587, seq 1, length 64
11:15:46.076589 IP 192.168.122.63 > 39.156.68.154: ICMP echo request, id 50587, seq 1, length 64
11:15:46.101708 IP 39.156.68.154 > 192.168.122.63: ICMP echo reply, id 50587, seq 1, length 64
11:15:46.101749 IP 39.156.68.154 > 192.168.102.237: ICMP echo reply, id 50587, seq 1, length 64
^C
4 packets captured
4 packets received by filter
0 packets dropped by kernel
leo@vu2004:~/tmp$ 

从lan口抓到一个包，又从路由对外的上网的口上也抓到了包，也就是snat前后的都有了 

==== DNAT 将以上已经设置好路由的主机，进行内网穿透 ====
注意一定是要在已经进行了路由设置上的主机做以下命令，如若不然要进行针对内网穿透规则的反向snat，才能将反向数据返回

==== 1.设置iptables dnat规则 将从进入主机节点的192.168.122.63的ip地址的，协议是tcp，端口是3333的数据报，dnat成ip端口为192.168.102.237:4444 ====
sudo iptables -t nat -R PREROUTING 1 -d 192.168.122.63 -p tcp -m tcp --dport 3333 -j DNAT --to-destination 192.168.102.237:4444

==== 2.在其他主机上连接路由主机的端口，192.168.122.63:3333 ====
192.168.122.1(client)  tcp -> 192.168.122.63:3333(route) -> 192.168.102.237:4444(server)

server :
root@iKuai:/root$nc -l -p 4444
fdsa
root@iKuai:/root$

client:
leo@HPZBook15:~$ nc 192.168.102.237 4444
fdsa

leo@HPZBook15:~$


==== -j LOG ====
=== 执行规则 ===
sudo iptables -t nat -I PREROUTING 1 -d 192.168.122.63 -p tcp -m tcp --dport 3333 -j  LOG --log-level debug

=== 跟路由主机网段的主机方位规则的ip及端口 ===
leo@HPZBook15:~$ nc 192.168.122.63 3333
fdsa


=== 模拟链接之后，看iptables的匹配包的个数 ====
leo@vu2004:~/tmp$ sudo iptables -t nat -L PREROUTING -vn
Chain PREROUTING (policy ACCEPT 16 packets, 960 bytes)
 pkts bytes target     prot opt in     out     source               destination
    2   120 LOG        tcp  --  *      *       0.0.0.0/0            192.168.122.63       tcp dpt:3333 LOG flags 0 level 7
    2   120 DNAT       tcp  --  *      *       0.0.0.0/0            192.168.122.63       tcp dpt:3333 to:192.168.102.237:4444


==== 查看日志的情况，日志文件及用dmesg查看的内容 ====
leo@vu2004:~/tmp$ sudo tail -f /var/log/syslog
Nov  4 06:33:20 vu2004 systemd[1]: apt-daily-upgrade.service: Succeeded.
Nov  4 06:33:20 vu2004 systemd[1]: Finished Daily apt upgrade and clean activities.
Nov  4 06:33:33 vu2004 systemd[1]: Starting Daily apt download activities...
Nov  4 06:33:52 vu2004 systemd[1]: apt-daily.service: Succeeded.
Nov  4 06:33:52 vu2004 systemd[1]: Finished Daily apt download activities.
Nov  4 06:38:42 vu2004 PackageKit: daemon quit
Nov  4 06:38:42 vu2004 systemd[1]: packagekit.service: Succeeded.
Nov  4 06:43:47 vu2004 systemd-networkd[722]: enp8s0: DHCP: No gateway received from DHCP server.
Nov  4 06:49:24 vu2004 kernel: [21724.995704] IN=enp1s0 OUT= MAC=52:54:00:10:49:a5:52:54:00:3f:a2:e8:08:00 SRC=192.168.122.1 DST=192.168.122.63 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=59851 DF PROTO=TCP SPT=40010 DPT=3333 WINDOW=64240 RES=0x00 SYN URGP=0
Nov  4 06:49:30 vu2004 kernel: [21730.595400] IN=enp1s0 OUT= MAC=52:54:00:10:49:a5:52:54:00:3f:a2:e8:08:00 SRC=192.168.122.1 DST=192.168.122.63 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=18434 DF PROTO=TCP SPT=57418 DPT=3333 WINDOW=64240 RES=0x00 SYN URGP=0





Nov  4 06:52:32 vu2004 kernel: [21912.673521] IN=enp1s0 OUT= MAC=52:54:00:10:49:a5:52:54:00:3f:a2:e8:08:00 SRC=192.168.122.1 DST=192.168.122.63 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=34320 DF PROTO=TCP SPT=46616 DPT=3333 WINDOW=64240 RES=0x00 SYN URGP=0
Nov  4 06:52:43 vu2004 kernel: [21924.158302] IN=enp1s0 OUT= MAC=52:54:00:10:49:a5:52:54:00:3f:a2:e8:08:00 SRC=192.168.122.1 DST=192.168.122.63 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=2409 DF PROTO=TCP SPT=44860 DPT=3333 WINDOW=64240 RES=0x00 SYN URGP=0

leo@vu2004:~/tmp$ dmesg
[21912.673521] IN=enp1s0 OUT= MAC=52:54:00:10:49:a5:52:54:00:3f:a2:e8:08:00 SRC=192.168.122.1 DST=192.168.122.63 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=34320 DF PROTO=TCP SPT=46616 DPT=3333 WINDOW=64240 RES=0x00 SYN URGP=0
[21924.158302] IN=enp1s0 OUT= MAC=52:54:00:10:49:a5:52:54:00:3f:a2:e8:08:00 SRC=192.168.122.1 DST=192.168.122.63 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=2409 DF PROTO=TCP SPT=44860 DPT=3333 WINDOW=64240 RES=0x00 SYN URGP=0

==== ip地址范围规则设置 -m iprange --src-range ip1-ip2 目的地址的省略 ==== 
sudo iptables -A INPUT -m iprange --src-range 192.168.101.1-192.168.122.254 -p tcp -m limit  --limit 20/minute --limit-burst 20  -j  LOG --log-level debug

规则设置后可以抓到不同地址的包，如果没有可以人为的制造一些
leo@vu2004:~/tmp$ sudo dmesg
[24924.396711] IN=enp8s0 OUT= MAC=52:54:00:2b:80:69:52:54:00:4d:59:3f:08:00 SRC=192.168.101.12 DST=192.168.101.207 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=12417 DF PROTO=TCP SPT=56276 DPT=22 WINDOW=64240 RES=0x00 SYN URGP=0
[24928.069683] IN=enp1s0 OUT= MAC=52:54:00:10:49:a5:52:54:00:3f:a2:e8:08:00 SRC=192.168.122.1 DST=192.168.122.63 LEN=96 TOS=0x10 PREC=0x00 TTL=64 ID=10649 DF PROTO=TCP SPT=48694 DPT=22 WINDOW=1897 RES=0x00 ACK PSH URGP=0
[24928.660226] IN=enp1s0 OUT= MAC=52:54:00:10:49:a5:52:54:00:3f:a2:e8:08:00 SRC=192.168.122.1 DST=192.168.122.63 LEN=88 TOS=0x10 PREC=0x00 TTL=64 ID=10651 DF PROTO=TCP SPT=48694 DPT=22 WINDOW=1897 RES=0x00 ACK PSH URGP=0

==== 连接信息限制设置，限制连接小于5时匹配规则 ====

sudo iptables -R INPUT 1 -m connlimit --connlimit-upto  5 --connlimit-saddr -m limit  --limit 20/minute --limit-burst 20  -j LOG --log-level debug

leo@vu2004:~/tmp$ dmesg
[27344.051706] IN=enp1s0 OUT= MAC=52:54:00:10:49:a5:52:54:00:3f:a2:e8:08:00 SRC=192.168.122.1 DST=192.168.122.63 LEN=96 TOS=0x10 PREC=0x00 TTL=64 ID=12730 DF PROTO=TCP SPT=48694 DPT=22 WINDOW=1897 RES=0x00 ACK PSH URGP=0
[27346.469560] IN=enp1s0 OUT= MAC=52:54:00:10:49:a5:52:54:00:3f:a2:e8:08:00 SRC=192.168.122.1 DST=192.168.122.63 LEN=96 TOS=0x10 PREC=0x00 TTL=64 ID=12736 DF PROTO=TCP SPT=48694 DPT=22 WINDOW=1897 RES=0x00 ACK PSH URGP=0
[27353.777037] IN=enp1s0 OUT= MAC=52:54:00:10:49:a5:52:54:00:3f:a2:e8:08:00 SRC=192.168.122.1 DST=192.168.122.63 LEN=96 TOS=0x10 PREC=0x00 TTL=64 ID=12748 DF PROTO=TCP SPT=48694 DPT=22 WINDOW=1897 RES=0x00 ACK PSH URGP=0
[27353.778910] IN=enp1s0 OUT= MAC=52:54:00:10:49:a5:52:54:00:3f:a2:e8:08:00 SRC=192.168.122.1 DST=192.168.122.63 LEN=52 TOS=0x10 PREC=0x00 TTL=64 ID=12749 DF PROTO=TCP SPT=48694 DPT=22 WINDOW=1897 RES=0x00 ACK URGP=0
leo@vu2004:~/tmp$ 

==== -g, --goto chain, like -j exceclude not return ====

=== 增加个自定义的链 ====
sudo iptables -N filter2 -t filter

==== 在新链上增加新规则 ====
sudo iptables -A filter2 -t filter -p tcp -m limit --limit 2 --limit-burst 2 -j LOG --log-level debug
sudo iptables -A filter2 -j RETURN

==== 将INPUT链上增加两条跳转到自定义链上的规则，一条用于真正的跳转，另一条用于验证执行第一条之后，后续的规则是否还能执行====
leo@vu2004:~/tmp$ sudo iptables -A INPUT -p tcp -g filter2
leo@vu2004:~/tmp$ sudo iptables -A INPUT -p tcp -g filter2


==== 增加后查看执行结果，没有跳转回原来的链 ====

leo@vu2004:~/tmp$ sudo iptables -vnL INPUT
Chain INPUT (policy ACCEPT 101 packets, 7052 bytes)
 pkts bytes target     prot opt in     out     source               destination
  405 28440 filter2    tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           [goto]
    0     0 filter2    tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           [goto]
leo@vu2004:~/tmp$ sudo iptables -vnL INPUT

leo@vu2004:~/source$ sudo iptables -vnL INPUT
Chain INPUT (policy ACCEPT 101 packets, 7052 bytes)
 pkts bytes target     prot opt in     out     source               destination
  111  7824 filter2    tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           [goto]
    0     0 filter2    tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           [goto]
leo@vu2004:~/source$ sudo iptables -vnL filter2
Chain filter2 (2 references)
 pkts bytes target     prot opt in     out     source               destination
   36  2844 LOG        tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            limit: avg 2/sec burst 2 LOG flags 0 level 7
  132  9168 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0

leo@vu2004:~/source$ sudo tail -f /var/log/syslog
Nov  6 15:46:58 vu2004 kernel: [45652.490614] IN=enp1s0 OUT= MAC=52:54:00:10:49:a5:52:54:00:3f:a2:e8:08:00 SRC=192.168.122.1 DST=192.168.122.63 LEN=88 TOS=0x10 PREC=0x00 TTL=64 ID=2297 DF PROTO=TCP SPT=32850 DPT=22 WINDOW=501 RES=0x00 ACK PSH URGP=0
Nov  6 15:46:59 vu2004 kernel: [45653.135645] IN=enp1s0 OUT= MAC=52:54:00:10:49:a5:52:54:00:3f:a2:e8:08:00 SRC=192.168.122.1 DST=192.168.122.63 LEN=52 TOS=0x10 PREC=0x00 TTL=64 ID=2299 DF PROTO=TCP SPT=32850 DPT=22 WINDOW=501 RES=0x00 ACK URGP=0

